<!-- analytics-dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AptioGen - Analytics Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      padding-top: 80px;
      background: var(--bg-primary);
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .dashboard-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .dashboard-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Filter Panel */
    .filter-panel {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .filter-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .filter-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s;
    }

    .filter-group select:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 15px;
      border: 2px solid var(--border-color);
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .stat-icon.primary {
      background: rgba(99, 102, 241, 0.2);
      color: var(--accent-primary);
    }

    .stat-icon.success {
      background: rgba(72, 187, 120, 0.2);
      color: var(--success);
    }

    .stat-icon.warning {
      background: rgba(251, 191, 36, 0.2);
      color: var(--warning);
    }

    .stat-icon.info {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    /* Highlight Cards */
    .highlight-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .highlight-card {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      padding: 30px;
      border-radius: 15px;
      position: relative;
      overflow: hidden;
    }

    .highlight-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    }

    .highlight-card h3 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .highlight-content {
      position: relative;
      z-index: 1;
    }

    .highlight-name {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .highlight-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
      font-size: 0.9rem;
    }

    .highlight-detail {
      background: rgba(255, 255, 255, 0.15);
      padding: 8px 12px;
      border-radius: 8px;
    }

    /* Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 15px;
      border: 2px solid var(--border-color);
    }

    .chart-card h3 {
      margin-bottom: 20px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    /* Tables */
    .table-card {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 15px;
      border: 2px solid var(--border-color);
      margin-bottom: 30px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .table-header h3 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
    }

    .table-responsive {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--bg-tertiary);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
    }

    td {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    tbody tr {
      transition: all 0.2s;
    }

    tbody tr:hover {
      background: var(--bg-tertiary);
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .rank-badge.gold {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: white;
      box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
    }

    .rank-badge.silver {
      background: linear-gradient(135deg, #C0C0C0, #808080);
      color: white;
      box-shadow: 0 2px 10px rgba(192, 192, 192, 0.3);
    }

    .rank-badge.bronze {
      background: linear-gradient(135deg, #CD7F32, #8B4513);
      color: white;
      box-shadow: 0 2px 10px rgba(205, 127, 50, 0.3);
    }

    .rank-badge.default {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .score-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .score-badge.excellent {
      background: rgba(72, 187, 120, 0.2);
      color: var(--success);
    }

    .score-badge.good {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .score-badge.average {
      background: rgba(251, 191, 36, 0.2);
      color: var(--warning);
    }

    .score-badge.poor {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    /* Loading State */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-content {
      text-align: center;
      color: white;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .filter-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .highlight-section {
        grid-template-columns: 1fr;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- Appbar -->
  <div class="appbar">
    <h2>AptioGen</h2>
    
    <div class="nav-links">
      <a href="explore.html">Explore</a>
      <a href="challenge.html">Challenge</a>
      <a href="brain-break.html">Brain Break</a>
    </div>
    
    <div class="right-icons">
      <i class="fa-solid fa-moon theme-toggle"></i>
      <div class="dropdown">
        <button class="dropbtn">
          <i class="fa-solid fa-user"></i>
        </button>
        <div class="dropdown-content">
          <a href="#"><i class="fa-solid fa-user"></i> Profile</a>
          <hr>
          <a href="#" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p style="margin-top: 20px; font-size: 1.2rem;">Loading Analytics...</p>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
      <div class="dashboard-title">
        <i class="fas fa-chart-line" style="font-size: 2rem; color: var(--accent-primary);"></i>
        <div>
          <h1 style="margin: 0;">Analytics Dashboard</h1>
          <p style="margin: 5px 0 0 0; color: var(--text-secondary);" id="eventName">Loading...</p>
        </div>
      </div>

      <div class="dashboard-actions">
        <button class="btn btn-secondary" onclick="refreshAnalytics()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-primary" onclick="exportToCSV()">
          <i class="fas fa-download"></i> Export CSV
        </button>
      </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel">
      <h3><i class="fas fa-filter"></i> Filters</h3>
      <div class="filter-grid">
        <div class="filter-group">
          <label for="collegeFilter">College</label>
          <select id="collegeFilter" onchange="applyFilters()">
            <option value="">All Colleges</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="departmentFilter">Department</label>
          <select id="departmentFilter" onchange="applyFilters()">
            <option value="">All Departments</option>
          </select>
        </div>

        <div class="filter-group" style="display: flex; align-items: flex-end;">
          <button class="btn btn-secondary" onclick="clearFilters()" style="width: 100%;">
            <i class="fas fa-times"></i> Clear Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid" id="statsGrid">
      <!-- Stats will be loaded here -->
    </div>

    <!-- Highlight Cards -->
    <div class="highlight-section" id="highlightSection">
      <!-- Top performer and fastest finisher cards -->
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3><i class="fas fa-chart-pie"></i> Score Distribution</h3>
        <div class="chart-container">
          <canvas id="scoreDistChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><i class="fas fa-chart-bar"></i> Department Performance</h3>
        <div class="chart-container">
          <canvas id="deptChart"></canvas>
        </div>
      </div>
    </div>

    <!-- College Performance Table -->
    <div class="table-card">
      <div class="table-header">
        <h3><i class="fas fa-building"></i> College Performance</h3>
      </div>
      <div class="table-responsive">
        <table id="collegeTable">
          <thead>
            <tr>
              <th>College</th>
              <th>Location</th>
              <th>Participants</th>
              <th>Avg Score</th>
              <th>Avg Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Department Comparison Table -->
    <div class="table-card">
      <div class="table-header">
        <h3><i class="fas fa-layer-group"></i> Department Ranking</h3>
      </div>
      <div class="table-responsive">
        <table id="deptTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Department</th>
              <th>Participants</th>
              <th>Avg Score</th>
              <th>Avg Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="table-card">
      <div class="table-header">
        <h3><i class="fas fa-trophy"></i> Leaderboard</h3>
      </div>
      <div class="table-responsive">
        <table id="leaderboardTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>College</th>
              <th>Department</th>
              <th>Score</th>
              <th>Percentage</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuth, setupLogoutButton } from "./js/auth.js";

    requireAuth();
    setupLogoutButton();

    let currentEventId = null;
    let analyticsData = null;
    let scoreDistChart = null;
    let deptChart = null;

    // Get event ID from URL
    const params = new URLSearchParams(window.location.search);
    currentEventId = params.get('eventId');

    if (!currentEventId) {
      alert('No event selected');
      window.location.href = 'challenge.html';
    }

    // Load analytics on page load
    window.addEventListener('DOMContentLoaded', async () => {
      await loadColleges();
      await loadAnalytics();
    });

    // Load colleges for filter
    async function loadColleges() {
      try {
        const response = await fetch('/api/analytics/colleges');
        const data = await response.json();
        
        if (data.success) {
          const select = document.getElementById('collegeFilter');
          data.colleges.forEach(college => {
            const option = document.createElement('option');
            option.value = college._id;
            option.textContent = college.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading colleges:', error);
      }
    }

    // Load analytics data
    async function loadAnalytics(collegeId = '', department = '') {
      try {
        showLoading(true);
        
        const token = localStorage.getItem('token');
        let url = `/api/analytics/event/${currentEventId}`;
        
        const queryParams = [];
        if (collegeId) queryParams.push(`collegeId=${collegeId}`);
        if (department) queryParams.push(`department=${encodeURIComponent(department)}`);
        if (queryParams.length > 0) url += `?${queryParams.join('&')}`;
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          analyticsData = data.analytics;
          renderAnalytics();
        } else {
          throw new Error(data.error || 'Failed to load analytics');
        }
        
      } catch (error) {
        console.error('Error loading analytics:', error);
        alert('Error loading analytics: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    // Render all analytics components
    function renderAnalytics() {
      if (!analyticsData) return;
      
      // Update event name
      document.getElementById('eventName').textContent = analyticsData.eventInfo.eventName;
      
      // Render stats cards
      renderStatsCards();
      
      // Render highlight cards
      renderHighlightCards();
      
      // Render charts
      renderCharts();
      
      // Render tables
      renderCollegeTable();
      renderDepartmentTable();
      renderLeaderboard();
    }

    // Render stats cards
    function renderStatsCards() {
      const { overview } = analyticsData;
      
      const statsHTML = `
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-icon primary">
              <i class="fas fa-users"></i>
            </div>
            <div>
              <div class="stat-value">${overview.totalParticipants}</div>
              <div class="stat-label">Total Participants</div>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-icon success">
              <i class="fas fa-check-circle"></i>
            </div>
            <div>
              <div class="stat-value">${overview.totalCompleted}</div>
              <div class="stat-label">Completed (${overview.completionRate}%)</div>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-icon warning">
              <i class="fas fa-chart-line"></i>
            </div>
            <div>
              <div class="stat-value">${overview.averagePercentage}%</div>
              <div class="stat-label">Average Score</div>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-icon info">
              <i class="fas fa-clock"></i>
            </div>
            <div>
              <div class="stat-value">${analyticsData.timeAnalysis.averageTimeFormatted}</div>
              <div class="stat-label">Average Time</div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('statsGrid').innerHTML = statsHTML;
    }

    // Render highlight cards
    function renderHighlightCards() {
      const { topPerformer, fastestFinisher } = analyticsData;
      
      let highlightHTML = '';
      
      if (topPerformer) {
        highlightHTML += `
          <div class="highlight-card">
            <h3><i class="fas fa-trophy"></i> Top Performer</h3>
            <div class="highlight-content">
              <div class="highlight-name">${topPerformer.name}</div>
              <div class="highlight-details">
                <div class="highlight-detail">
                  <i class="fas fa-building"></i> ${topPerformer.college}
                </div>
                <div class="highlight-detail">
                  <i class="fas fa-graduation-cap"></i> ${topPerformer.department}
                </div>
                <div class="highlight-detail">
                  <i class="fas fa-star"></i> ${topPerformer.percentage}%
                </div>
                <div class="highlight-detail">
                  <i class="fas fa-check-circle"></i> ${topPerformer.score}/${topPerformer.totalQuestions}
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      if (fastestFinisher) {
        highlightHTML += `
          <div class="highlight-card" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
            <h3><i class="fas fa-bolt"></i> Fastest Finisher</h3>
            <div class="highlight-content">
              <div class="highlight-name">${fastestFinisher.name}</div>
              <div class="highlight-details">
                <div class="highlight-detail">
                  <i class="fas fa-building"></i> ${fastestFinisher.college}
                </div>
                <div class="highlight-detail">
                  <i class="fas fa-graduation-cap"></i> ${fastestFinisher.department}
                </div>
                <div class="highlight-detail">
                  <i class="fas fa-clock"></i> ${fastestFinisher.timeTakenFormatted}
                </div>
                <div class="highlight-detail">
                  <i class="fas fa-star"></i> ${fastestFinisher.percentage}%
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      document.getElementById('highlightSection').innerHTML = highlightHTML;
    }

    // Render charts
    function renderCharts() {
      renderScoreDistributionChart();
      renderDepartmentChart();
    }

    // Render score distribution chart
    function renderScoreDistributionChart() {
      const ctx = document.getElementById('scoreDistChart').getContext('2d');
      
      if (scoreDistChart) {
        scoreDistChart.destroy();
      }
      
      const { scoreDistribution } = analyticsData;
      
      scoreDistChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Excellent (90-100%)', 'Good (70-89%)', 'Average (50-69%)', 'Poor (<50%)'],
          datasets: [{
            data: [
              scoreDistribution.excellent,
              scoreDistribution.good,
              scoreDistribution.average,
              scoreDistribution.poor
            ],
            backgroundColor: [
              'rgba(72, 187, 120, 0.8)',
              'rgba(59, 130, 246, 0.8)',
              'rgba(251, 191, 36, 0.8)',
              'rgba(239, 68, 68, 0.8)'
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Render department chart
    function renderDepartmentChart() {
      const ctx = document.getElementById('deptChart').getContext('2d');
      
      if (deptChart) {
        deptChart.destroy();
      }
      
      const { departmentComparison } = analyticsData;
      const topDepts = departmentComparison.slice(0, 10);
      
      deptChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: topDepts.map(d => d.department),
          datasets: [{
            label: 'Average Score (%)',
            data: topDepts.map(d => d.averageScore),
            backgroundColor: 'rgba(99, 102, 241, 0.8)',
            borderColor: 'rgba(99, 102, 241, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // Render college table
    function renderCollegeTable() {
      const { collegePerformance } = analyticsData;
      const tbody = document.querySelector('#collegeTable tbody');
      
      tbody.innerHTML = collegePerformance.map(college => `
        <tr>
          <td><strong>${college.collegeName}</strong></td>
          <td>${college.location?.city || 'N/A'}, ${college.location?.state || 'N/A'}</td>
          <td>${college.completedParticipants} / ${college.totalParticipants}</td>
          <td><span class="score-badge ${getScoreBadgeClass(college.averageScore)}">${college.averageScore}%</span></td>
          <td>${college.averageTimeFormatted}</td>
        </tr>
      `).join('');
    }

    // Render department table
    function renderDepartmentTable() {
      const { departmentComparison } = analyticsData;
      const tbody = document.querySelector('#deptTable tbody');
      
      tbody.innerHTML = departmentComparison.map(dept => `
        <tr>
          <td>
            <span class="rank-badge ${getRankBadgeClass(dept.rank)}">
              ${dept.rank}
            </span>
          </td>
          <td><strong>${dept.department}</strong></td>
          <td>${dept.completedParticipants} / ${dept.totalParticipants}</td>
          <td><span class="score-badge ${getScoreBadgeClass(dept.averageScore)}">${dept.averageScore}%</span></td>
          <td>${dept.averageTimeFormatted}</td>
        </tr>
      `).join('');
    }

    // Render leaderboard
    function renderLeaderboard() {
      const { leaderboard } = analyticsData;
      const tbody = document.querySelector('#leaderboardTable tbody');
      
      tbody.innerHTML = leaderboard.map(entry => `
        <tr>
          <td>
            <span class="rank-badge ${getRankBadgeClass(entry.rank)}">
              ${entry.rank}
            </span>
          </td>
          <td><strong>${entry.name}</strong><br><small style="color: var(--text-tertiary);">${entry.rollNo}</small></td>
          <td>${entry.college}</td>
          <td>${entry.department}</td>
          <td>${entry.score} / ${entry.totalQuestions}</td>
          <td><span class="score-badge ${getScoreBadgeClass(entry.percentage)}">${entry.percentage}%</span></td>
          <td>${entry.timeTakenFormatted}</td>
        </tr>
      `).join('');
    }

    // Helper functions
    function getRankBadgeClass(rank) {
      if (rank === 1) return 'gold';
      if (rank === 2) return 'silver';
      if (rank === 3) return 'bronze';
      return 'default';
    }

    function getScoreBadgeClass(score) {
      if (score >= 90) return 'excellent';
      if (score >= 70) return 'good';
      if (score >= 50) return 'average';
      return 'poor';
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    // Filter functions
    window.applyFilters = async function() {
      const collegeId = document.getElementById('collegeFilter').value;
      const department = document.getElementById('departmentFilter').value;
      
      await loadAnalytics(collegeId, department);
    };

    window.clearFilters = function() {
      document.getElementById('collegeFilter').value = '';
      document.getElementById('departmentFilter').value = '';
      loadAnalytics();
    };

    window.refreshAnalytics = function() {
      const collegeId = document.getElementById('collegeFilter').value;
      const department = document.getElementById('departmentFilter').value;
      loadAnalytics(collegeId, department);
    };

    window.exportToCSV = async function() {
      try {
        const token = localStorage.getItem('token');
        const collegeId = document.getElementById('collegeFilter').value;
        const department = document.getElementById('departmentFilter').value;
        
        let url = `/api/analytics/event/${currentEventId}/export`;
        const queryParams = [];
        if (collegeId) queryParams.push(`collegeId=${collegeId}`);
        if (department) queryParams.push(`department=${encodeURIComponent(department)}`);
        if (queryParams.length > 0) url += `?${queryParams.join('&')}`;
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `analytics-${currentEventId}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        
      } catch (error) {
        console.error('Export error:', error);
        alert('Error exporting data');
      }
    };
  </script>
  <script src="js/theme.js" type="module"></script>
</body>
</html>