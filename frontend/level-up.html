level-up.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AptioGen - Level Up</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/components.css">
  <style>
    body {
      padding-top: 80px;
      min-height: 100vh;
    }
    
    .progress-overview {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-card i {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .stat-card h3 {
      font-size: 2rem;
      margin: 10px 0 5px 0;
      color: var(--text-primary);
    }
    
    .stat-card p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0;
    }
    
    .skill-tree {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
    }
    
    .skill-category {
      margin-bottom: 30px;
    }
    
    .skill-category h3 {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .skill-bar {
      background: var(--bg-tertiary);
      height: 40px;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 15px;
      position: relative;
    }
    
    .skill-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      display: flex;
      align-items: center;
      padding: 0 15px;
      color: white;
      font-weight: 600;
      transition: width 1s ease;
      width: 0%;
    }
    
    .achievements {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
    }
    
    .achievement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .achievement-badge {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .achievement-badge:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px var(--shadow);
    }
    
    .achievement-badge.locked {
      opacity: 0.5;
      filter: grayscale(1);
    }
    
    .achievement-badge i {
      font-size: 3rem;
      margin-bottom: 10px;
      color: var(--accent-primary);
    }
    
    .achievement-badge.locked i {
      color: var(--text-secondary);
    }
    
    .achievement-badge h4 {
      font-size: 0.9rem;
      margin: 5px 0;
      color: var(--text-primary);
    }

    .achievement-badge p {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin: 0;
    }

    .no-data-message {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .category-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .category-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .category-count {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- Appbar -->
  <div class="appbar">
    <h2>AptioGen</h2>
    
    <div class="nav-links">
      <a href="explore.html">Explore</a>
      <a href="challenge.html">Challenge</a>
      <a href="level-up.html" class="active">Level Up</a>
    </div>
    
    <div class="right-icons">
      <i class="fa-solid fa-moon theme-toggle"></i>
      <div class="dropdown">
        <button class="dropbtn">
          <i class="fa-solid fa-user"></i>
        </button>
        <div class="dropdown-content">
          <a href="#"><i class="fa-solid fa-user"></i> Profile</a>
          <hr>
          <a href="#" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <h1>Your Progress Dashboard</h1>
    
    <div id="loadingMessage" class="loading">
      <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
      <p>Loading your progress...</p>
    </div>

    <div id="mainContent" style="display: none;">
      <!-- Progress Overview -->
      <div class="progress-overview">
        <h2>Performance Overview</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <i class="fas fa-check-circle"></i>
            <h3 id="completedSets">0</h3>
            <p>Sets Completed</p>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-star"></i>
            <h3 id="avgScore">0%</h3>
            <p>Average Score</p>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-trophy"></i>
            <h3 id="totalPoints">0</h3>
            <p>Total Points</p>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-fire"></i>
            <h3 id="streak">0</h3>
            <p>Day Streak</p>
          </div>
        </div>
      </div>

      <!-- Skill Tree -->
      <div class="skill-tree">
        <h2>Skill Progress by Category</h2>
        <div id="skillCategories"></div>
        <div id="noProgressMessage" class="no-data-message" style="display: none;">
          <p>Complete some practice sets to see your progress here!</p>
        </div>
      </div>

      <!-- Achievements -->
      <div class="achievements">
        <h2>Achievements</h2>
        <div class="achievement-grid">
          <div class="achievement-badge locked" id="badge-first-steps">
            <i class="fas fa-graduation-cap"></i>
            <h4>First Steps</h4>
            <p>Complete first quiz</p>
          </div>
          
          <div class="achievement-badge locked" id="badge-perfect-score">
            <i class="fas fa-medal"></i>
            <h4>Perfect Score</h4>
            <p>Get 100% on a quiz</p>
          </div>
          
          <div class="achievement-badge locked" id="badge-hot-streak">
            <i class="fas fa-fire"></i>
            <h4>Hot Streak</h4>
            <p>7 day streak</p>
          </div>
          
          <div class="achievement-badge locked" id="badge-master">
            <i class="fas fa-crown"></i>
            <h4>Master</h4>
            <p>Complete 50 sets</p>
          </div>
          
          <div class="achievement-badge locked" id="badge-speed-demon">
            <i class="fas fa-rocket"></i>
            <h4>Speed Demon</h4>
            <p>Complete in under 5 min</p>
          </div>
          
          <div class="achievement-badge locked" id="badge-dedicated">
            <i class="fas fa-trophy"></i>
            <h4>Dedicated</h4>
            <p>Complete 10 sets</p>
          </div>
        </div>
      </div>
    </div>
  </div>

 
  <script type="module">
    import { requireAuth, setupLogoutButton } from "./js/auth.js";
    import { practiceAPI } from "./js/api.js";

    // Calculate streak from completion dates
    function calculateStreak(progress) {
      const completedDates = progress
        .filter(p => p.completed && p.completedAt)
        .map(p => {
          const date = new Date(p.completedAt);
          return new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
        })
        .filter((date, index, self) => self.indexOf(date) === index) // unique dates
        .sort((a, b) => b - a); // newest first

      if (completedDates.length === 0) return 0;

      let streak = 0;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayTime = today.getTime();

      // Check if there's activity today or yesterday
      const lastActivityTime = completedDates[0];
      const daysSinceActivity = Math.floor((todayTime - lastActivityTime) / (1000 * 60 * 60 * 24));
      
      if (daysSinceActivity > 1) {
        return 0; // Streak broken
      }

      // Count consecutive days backward from most recent activity
      let currentCheckDate = lastActivityTime;
      for (const activityDate of completedDates) {
        if (activityDate === currentCheckDate) {
          streak++;
          currentCheckDate -= (1000 * 60 * 60 * 24); // Go back one day
        } else if (activityDate < currentCheckDate) {
          // Gap found, streak broken
          break;
        }
      }

      return streak;
    }

    // Update achievement badges based on progress
    function updateAchievements(progress, streak, completedCount, hasHundredPercent) {
      // First Steps - Complete first quiz
      if (completedCount > 0) {
        document.getElementById('badge-first-steps').classList.remove('locked');
      }

      // Perfect Score - Get 100% on a quiz
      if (hasHundredPercent) {
        document.getElementById('badge-perfect-score').classList.remove('locked');
      }

      // Hot Streak - 7 day streak
      if (streak >= 7) {
        document.getElementById('badge-hot-streak').classList.remove('locked');
      }

      // Master - Complete 50 sets
      if (completedCount >= 50) {
        document.getElementById('badge-master').classList.remove('locked');
      }

      // Dedicated - Complete 10 sets
      if (completedCount >= 10) {
        document.getElementById('badge-dedicated').classList.remove('locked');
      }

      // Speed Demon - Complete quiz in record time (under 5 minutes)
      const hasFastCompletion = progress.some(p => {
        if (!p.completed || !p.startedAt || !p.completedAt) return false;
        const duration = (new Date(p.completedAt) - new Date(p.startedAt)) / 60000;
        return duration < 5;
      });
      if (hasFastCompletion) {
        document.getElementById('badge-speed-demon').classList.remove('locked');
      }
    }

    // Get icon for category
    function getCategoryIcon(category) {
      const categoryLower = category.toLowerCase();
      if (categoryLower.includes('aptitude')) return 'fa-brain';
      if (categoryLower.includes('reason')) return 'fa-lightbulb';
      if (categoryLower.includes('coding') || categoryLower.includes('code')) return 'fa-code';
      if (categoryLower.includes('technical') || categoryLower.includes('tech')) return 'fa-laptop-code';
      return 'fa-book';
    }

    // Animate number counting
    function animateValue(id, start, end, duration, suffix = '') {
      const element = document.getElementById(id);
      const range = end - start;
      const increment = range / (duration / 16);
      let current = start;
      
      const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
          current = end;
          clearInterval(timer);
        }
        element.textContent = Math.round(current) + suffix;
      }, 16);
    }

    async function loadProgress() {
      try {
        console.log("üìä Fetching progress data...");
        const { progress } = await practiceAPI.getProgress();
        
        console.log("‚úÖ Progress data received:", progress);

        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        if (!progress || progress.length === 0) {
          console.log("‚ÑπÔ∏è No progress data found");
          document.getElementById('noProgressMessage').style.display = 'block';
          return;
        }

        // Filter only completed sets
        const completedSets = progress.filter(p => p.completed);
        console.log(`üìà Completed sets: ${completedSets.length} / ${progress.length}`);

        // Calculate overall stats
        const completedCount = completedSets.length;
        
        // Calculate total score and questions
        const totalScore = completedSets.reduce((sum, p) => sum + (p.score || 0), 0);
        const totalQuestions = completedSets.reduce((sum, p) => sum + (p.totalQuestions || 0), 0);
        
        // Calculate average score percentage
        const avgScore = totalQuestions > 0 
          ? Math.round((totalScore / totalQuestions) * 100) 
          : 0;
        
        // Calculate total points (score * 10)
        const totalPoints = totalScore * 10;
        
        // Calculate streak
        const streak = calculateStreak(progress);
        
        // Check for perfect scores
        const hasHundredPercent = completedSets.some(p => 
          p.score === p.totalQuestions && p.totalQuestions > 0
        );

        console.log("üìä Stats calculated:", {
          completedCount,
          totalScore,
          totalQuestions,
          avgScore: `${avgScore}%`,
          totalPoints,
          streak,
          hasHundredPercent
        });
        
        // Update stats with animation
        animateValue('completedSets', 0, completedCount, 1000);
        animateValue('avgScore', 0, avgScore, 1000, '%');
        animateValue('totalPoints', 0, totalPoints, 1000);
        animateValue('streak', 0, streak, 1000);
        
        // Update achievements
        updateAchievements(progress, streak, completedCount, hasHundredPercent);

        // Group progress by category
        const categoryMap = {};
        progress.forEach(p => {
          if (!categoryMap[p.category]) {
            categoryMap[p.category] = {
              total: 0,
              completed: 0,
              totalScore: 0,
              totalQuestions: 0
            };
          }
          categoryMap[p.category].total++;
          if (p.completed) {
            categoryMap[p.category].completed++;
            categoryMap[p.category].totalScore += p.score || 0;
            categoryMap[p.category].totalQuestions += p.totalQuestions || 0;
          }
        });

        console.log("üìö Category breakdown:", categoryMap);

        // Render category progress bars
        const skillCategoriesContainer = document.getElementById('skillCategories');
        skillCategoriesContainer.innerHTML = '';

        const sortedCategories = Object.keys(categoryMap).sort();
        
        if (sortedCategories.length === 0) {
          document.getElementById('noProgressMessage').style.display = 'block';
          return;
        }

        sortedCategories.forEach((category, index) => {
          const data = categoryMap[category];
          const percentage = data.total > 0 
            ? Math.round((data.completed / data.total) * 100) 
            : 0;
          const categoryScore = data.totalQuestions > 0
            ? Math.round((data.totalScore / data.totalQuestions) * 100)
            : 0;

          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'skill-category';
          categoryDiv.innerHTML = `
            <h3>
              <i class="fas ${getCategoryIcon(category)}"></i> 
              ${category.charAt(0).toUpperCase() + category.slice(1)}
            </h3>
            <div class="category-stats">
              <span class="category-name">${data.completed} / ${data.total} sets completed</span>
              <span class="category-count">Avg Score: ${categoryScore}%</span>
            </div>
            <div class="skill-bar">
              <div class="skill-progress" style="width: 0%">${percentage}%</div>
            </div>
          `;
          
          skillCategoriesContainer.appendChild(categoryDiv);

          // Animate the progress bar with stagger
          setTimeout(() => {
            const progressBar = categoryDiv.querySelector('.skill-progress');
            progressBar.style.width = percentage + '%';
          }, 100 + (index * 100));
        });

      } catch (error) {
        console.error("‚ùå Error loading progress:", error);
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('noProgressMessage').textContent = 
          'Error loading progress. Please try again later.';
        document.getElementById('noProgressMessage').style.display = 'block';
      }
    }

    // ‚úÖ PROPER INITIALIZATION - Wait for auth BEFORE loading data
    async function init() {
      try {
        console.log("üîê Waiting for authentication...");
        
        // Wait for authentication to complete
        await requireAuth();
        
        console.log("‚úÖ Authentication complete, setting up page...");
        
        // Setup logout button
        setupLogoutButton();
        
        // Now load progress data
        await loadProgress();
        
      } catch (error) {
        console.error("‚ùå Initialization error:", error);
        // User will be redirected by requireAuth if not authenticated
      }
    }

    // Start initialization when page loads
    init();
  </script>

  <script src="js/theme.js" type="module"></script>
</body>
