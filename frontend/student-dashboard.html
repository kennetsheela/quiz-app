<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - AptioGen</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        .dashboard-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 20px 0;
        }

        .sidebar-item {
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            color: #3b82f6;
            background: #f0f7ff;
            border-right: 3px solid #3b82f6;
        }

        .main-content {
            padding: 30px;
            background: #f8fafc;
            overflow-y: auto;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .event-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .event-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-color: #3b82f6;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin-top: 8px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 4px;
            background: #3b82f6;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <header class="appbar">
        <h2>AptioGen</h2>
        <div class="right-icons">
            <span id="userName" class="fw-600 mr-3"></span>
            <i class="fa-solid fa-bell mr-3"></i>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-item active" onclick="showView('overview')">
                <i class="fa-solid fa-chart-pie"></i> Overview
            </div>
            <div class="sidebar-item" onclick="showView('events')">
                <i class="fa-solid fa-calendar-alt"></i> Quizzes/Events
            </div>
            <div class="sidebar-item" onclick="showView('practice')">
                <i class="fa-solid fa-dumbbell"></i> Practice Center
            </div>
            <div class="sidebar-item" onclick="showView('results')">
                <i class="fa-solid fa-file-invoice"></i> My Results
            </div>
            <div class="sidebar-item" onclick="showView('leaderboard')">
                <i class="fa-solid fa-trophy"></i> Leaderboard
            </div>
            <div class="sidebar-item" onclick="showView('profile')">
                <i class="fa-solid fa-user"></i> My Profile
            </div>
        </aside>

        <main class="main-content" id="dashboardContent">
            <!-- Overview View -->
            <div id="overviewView">
                <div class="flex justify-between align-center mb-4">
                    <h1>Dashboard Overview</h1>
                    <div id="studentBadge" class="badge badge-primary">Independent Student</div>
                </div>

                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #eff6ff; color: #3b82f6;">
                            <i class="fa-solid fa-calendar-check"></i>
                        </div>
                        <div>
                            <div class="small text-secondary">Participated</div>
                            <div class="fs-24 fw-700" id="statParticipated">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #ecfdf5; color: #10b981;">
                            <i class="fa-solid fa-star"></i>
                        </div>
                        <div>
                            <div class="small text-secondary">Avg. Score</div>
                            <div class="fs-24 fw-700" id="statAvgScore">0%</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #fff7ed; color: #f59e0b;">
                            <i class="fa-solid fa-ranking-star"></i>
                        </div>
                        <div>
                            <div class="small text-secondary">Global Rank</div>
                            <div class="fs-24 fw-700" id="statRank">#0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #fef2f2; color: #ef4444;">
                            <i class="fa-solid fa-bolt"></i>
                        </div>
                        <div>
                            <div class="small text-secondary">Practice Streak</div>
                            <div class="fs-24 fw-700" id="statStreak">0 Days</div>
                        </div>
                    </div>
                </div>

                <div class="grid col-2 gap-4">
                    <div class="chart-container">
                        <h3>Performance Trend (Practice)</h3>
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Year-wise Progress (Events)</h3>
                        <canvas id="yearWiseChart"></canvas>
                    </div>
                </div>

                <div class="card mb-4">
                    <h3>Upcoming Events</h3>
                    <div id="upcomingEventsList">
                        <p class="text-center text-secondary py-4">No upcoming events found</p>
                    </div>
                </div>
            </div>

            <!-- Other views will be loaded dynamically -->
            <div id="dynamicView" style="display: none;"></div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initTheme } from './js/theme.js';
        import { auth } from './js/firebase.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        initTheme();

        const API_BASE = 'http://localhost:5000/api';
        let studentData = JSON.parse(sessionStorage.getItem('studentInfo'));
        let profileData = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'student-login.html';
            } else {
                fetchStudentProfile(user);
            }
        });

        async function fetchStudentProfile(user) {
            try {
                const idToken = await user.getIdToken();
                const response = await fetch(`${API_BASE}/students/profile`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    studentData = data.user;
                    profileData = data.profile;
                    sessionStorage.setItem('studentInfo', JSON.stringify(studentData));
                    displayDashboard();
                }
            } catch (error) {
                console.error('Error fetching student data:', error);
            }
        }

        function displayDashboard() {
            document.getElementById('userName').textContent = studentData.username;
            if (studentData.institutionId) {
                document.getElementById('studentBadge').textContent = 'Institutional Student';
                document.getElementById('studentBadge').className = 'badge badge-success';
            }

            // Stats
            document.getElementById('statParticipated').textContent = profileData?.totalEventsAttended || '0';
            document.getElementById('statAvgScore').textContent = (profileData?.overallAverage || 0) + '%';
            document.getElementById('statRank').textContent = '#' + (profileData?.rankings?.institutionRank || '0');

            // Initial view
            showView('overview');
            loadUpcomingEvents();
            initCharts();
        }

        window.showView = (view) => {
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (view === 'overview') {
                document.getElementById('overviewView').style.display = 'block';
                document.getElementById('dynamicView').style.display = 'none';
            } else {
                document.getElementById('overviewView').style.display = 'none';
                document.getElementById('dynamicView').style.display = 'block';
                loadDynamicView(view);
            }
        };

        async function loadDynamicView(view) {
            const container = document.getElementById('dynamicView');
            container.innerHTML = `<h2>${view.charAt(0).toUpperCase() + view.slice(1)}</h2><p>Content for ${view} coming soon...</p>`;

            if (view === 'events') {
                loadEventsView();
            }
        }

        async function loadEventsView() {
            const container = document.getElementById('dynamicView');
            container.innerHTML = `
                <div class="flex justify-between align-center mb-4">
                    <h1>My Quizzes & Events</h1>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-primary">Active</button>
                        <button class="btn btn-sm btn-outline-secondary">Completed</button>
                    </div>
                </div>
                <div id="eventsListFull">Loading events...</div>
            `;

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch(`${API_BASE}/students/events/available`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });
                const data = await response.json();

                const list = document.getElementById('eventsListFull');
                if (data.events && data.events.length > 0) {
                    list.innerHTML = data.events.map(event => `
                        <div class="event-card">
                            <div>
                                <h4 class="mb-1">${event.title}</h4>
                                <p class="small text-secondary mb-0">
                                    <i class="fa-solid fa-clock mr-1"></i> Ends: ${new Date(event.endTime).toLocaleString()}
                                </p>
                            </div>
                            <div class="flex align-center gap-3">
                                <span class="badge ${event.category === 'Technical' ? 'badge-primary' : 'badge-secondary'}">${event.category}</span>
                                <button class="btn btn-primary" onclick="startEvent('${event._id}')">Start Quiz</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<p class="text-center py-5">No active events found for you.</p>';
                }
            } catch (error) {
                list.innerHTML = '<p class="text-danger">Failed to load events.</p>';
            }
        }

        async function loadStats() {
            // Mocking stats update for now or fetch from profile
            document.getElementById('statParticipated').textContent = '12';
            document.getElementById('statAvgScore').textContent = '84%';
            document.getElementById('statRank').textContent = '#156';
            document.getElementById('statStreak').textContent = '5 Days';
        }

        async function loadUpcomingEvents() {
            // Similar to loadEventsView but mini version
        }

        function initCharts() {
            // Performance Trend Chart
            const ctxPerf = document.getElementById('performanceChart').getContext('2d');
            new Chart(ctxPerf, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Avg Score %',
                        data: [65, 72, 68, 85, 82, 90],
                        borderColor: '#3b82f6',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });

            // Year-wise Progress Chart
            const ctxYear = document.getElementById('yearWiseChart').getContext('2d');
            const yearLabels = profileData?.yearWisePerformance?.map(y => `Year ${y.year}`) || ['Year 1', 'Year 2', 'Year 3', 'Year 4'];
            const yearData = profileData?.yearWisePerformance?.map(y => y.averageScore) || [0, 0, 0, 0];

            new Chart(ctxYear, {
                type: 'bar',
                data: {
                    labels: yearLabels,
                    datasets: [{
                        label: 'Average Score %',
                        data: yearData,
                        backgroundColor: '#10b981',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        window.logout = async () => {
            await signOut(auth);
            sessionStorage.removeItem('studentInfo');
            window.location.href = 'student-login.html';
        };

        window.startEvent = (id) => {
            window.location.href = `quiz.html?eventId=${id}`;
        };
    </script>
</body>

</html>