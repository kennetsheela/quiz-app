<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registration - Institution Portal - AptioGen</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .register-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 60px var(--shadow);
            border: 1px solid var(--border-color);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .logo p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .input-wrapper input,
        .input-wrapper select {
            padding-left: 45px;
            width: 100%;
        }

        .loading-spinner {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: var(--accent-primary);
            display: none;
        }

        .loading-spinner.active {
            display: block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: translateY(-50%) rotate(360deg);
            }
        }

        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            background: var(--error);
        }

        .password-strength-bar.weak {
            width: 33%;
            background: var(--error);
        }

        .password-strength-bar.medium {
            width: 66%;
            background: var(--warning);
        }

        .password-strength-bar.strong {
            width: 100%;
            background: var(--success);
        }

        .terms {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .terms input {
            width: auto;
            margin-right: 8px;
        }

        .terms a {
            color: var(--accent-primary);
            font-weight: 500;
        }

        .login-link {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .login-link a {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .badge-inst {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent-primary);
            border-radius: 99px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="register-container">
        <div class="logo">
            <div class="badge-inst">Institution Student</div>
            <h1>AptioGen</h1>
            <p>Connect with your Institution</p>
        </div>

        <form id="registerForm">
            <!-- Standard Fields -->
            <div class="form-group">
                <label for="name">Full Name</label>
                <div class="input-wrapper">
                    <i class="fas fa-user"></i>
                    <input type="text" id="name" placeholder="Enter your full name" required>
                </div>
            </div>

            <div class="form-group">
                <label for="email">Email Address</label>
                <div class="input-wrapper">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="email" placeholder="Enter your email" required>
                </div>
            </div>

            <!-- Institution Cascading Fields -->
            <div class="form-group">
                <label for="regInst">Select Institution</label>
                <div class="input-wrapper">
                    <i class="fas fa-building-columns"></i>
                    <select id="regInst" required>
                        <option value="">-- Choose Institution --</option>
                    </select>
                    <i class="fas fa-circle-notch loading-spinner" id="instLoader"></i>
                </div>
            </div>

            <div class="form-group">
                <label for="regDept">Select Department</label>
                <div class="input-wrapper">
                    <i class="fas fa-microchip"></i>
                    <select id="regDept" required disabled>
                        <option value="">-- Select Department --</option>
                    </select>
                    <i class="fas fa-circle-notch loading-spinner" id="deptLoader"></i>
                </div>
            </div>

            <div class="form-group">
                <label for="regBatch">Select Batch</label>
                <div class="input-wrapper">
                    <i class="fas fa-graduation-cap"></i>
                    <select id="regBatch" required disabled>
                        <option value="">-- Select Batch --</option>
                    </select>
                    <i class="fas fa-circle-notch loading-spinner" id="batchLoader"></i>
                </div>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <div class="input-wrapper">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" placeholder="Create a password" required minlength="6">
                </div>
                <div class="password-strength">
                    <div class="password-strength-bar" id="strengthBar"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <div class="input-wrapper">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                </div>
            </div>

            <div class="terms">
                <label>
                    <input type="checkbox" id="agreeTerms" required>
                    I agree to the <a href="#" onclick="showTerms()">Terms of Service</a>
                </label>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%;">Create Student Account</button>

            <div class="login-link">
                Already have an account? <a href="student-login.html">Sign in</a>
            </div>
        </form>
    </div>

    <!-- Terms & Conditions Modal -->
    <div class="modal" id="termsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header flex justify-between items-center mb-4">
                <h3 class="mb-0">Terms & Conditions</h3>
                <button class="close-modal" onclick="closeTermsModal()"
                    style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="termsContainer" class="p-4 bg-light rounded"
                style="max-height: 400px; overflow-y: auto; line-height: 1.6;">
                Loading...
            </div>
            <button class="btn btn-primary w-100 mt-4" onclick="closeTermsModal()">I Understand</button>
        </div>
    </div>

    <script type="module">
        import { auth } from "./js/firebase.js";
        import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import API_CONFIG from "./js/config.js";

        const API_BASE = API_CONFIG.API_URL;
        const registerForm = document.getElementById("registerForm");
        const passwordInput = document.getElementById("password");
        const strengthBar = document.getElementById("strengthBar");

        // Dynamic Loading Elements
        const instSelect = document.getElementById("regInst");
        const deptSelect = document.getElementById("regDept");
        const batchSelect = document.getElementById("regBatch");
        const instLoader = document.getElementById("instLoader");
        const deptLoader = document.getElementById("deptLoader");
        const batchLoader = document.getElementById("batchLoader");

        // Initialize Institutions
        async function fetchInstitutions() {
            instLoader.classList.add("active");
            try {
                const res = await fetch(`${API_BASE}/public/institutions`);
                const data = await res.json();
                instSelect.innerHTML = '<option value="">-- Choose Institution --</option>';
                data.forEach(inst => {
                    const opt = document.createElement("option");
                    opt.value = inst._id;
                    opt.textContent = inst.name;
                    instSelect.appendChild(opt);
                });
            } catch (e) {
                console.error("Error fetching institutions", e);
            } finally {
                instLoader.classList.remove("active");
            }
        }

        instSelect.addEventListener("change", async (e) => {
            const instId = e.target.value;
            deptSelect.innerHTML = '<option value="">-- Select Department --</option>';
            deptSelect.disabled = !instId;
            batchSelect.innerHTML = '<option value="">-- Select Batch --</option>';
            batchSelect.disabled = true;

            if (instId) {
                deptLoader.classList.add("active");
                try {
                    const res = await fetch(`${API_BASE}/public/institutions/${instId}/departments`);
                    const depts = await res.json();
                    depts.forEach(d => {
                        const opt = document.createElement("option");
                        opt.value = d._id;
                        opt.textContent = d.name;
                        deptSelect.appendChild(opt);
                    });
                } catch (e) {
                    console.error("Error fetching depts", e);
                } finally {
                    deptLoader.classList.remove("active");
                }
            }
        });

        deptSelect.addEventListener("change", async (e) => {
            const instId = instSelect.value;
            const deptId = e.target.value;
            batchSelect.innerHTML = '<option value="">-- Select Batch --</option>';
            batchSelect.disabled = !deptId;

            if (deptId) {
                batchLoader.classList.add("active");
                try {
                    const res = await fetch(`${API_BASE}/public/institutions/${instId}/batches?deptId=${deptId}`);
                    const batches = await res.json();
                    batches.forEach(b => {
                        const opt = document.createElement("option");
                        opt.value = b._id;
                        // Robust label: check batchID first, then name
                        const label = b.batchID || b.name || "Unnamed Batch";
                        opt.textContent = `${label} (${b.startYear}-${b.endYear})`;
                        batchSelect.appendChild(opt);
                    });
                } catch (e) {
                    console.error("Error fetching batches", e);
                } finally {
                    batchLoader.classList.remove("active");
                }
            }
        });

        // Terms & Conditions Modal
        window.showTerms = async () => {
            const modal = document.getElementById("termsModal");
            const container = document.getElementById("termsContainer");
            modal.classList.add("active");
            try {
                const res = await fetch(`${API_BASE}/public/settings/studentTerms`);
                const data = await res.json();
                if (data.value) {
                    const html = data.value
                        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                        .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
                        .replace(/\n/gim, '<br>');
                    container.innerHTML = html;
                } else {
                    container.innerHTML = "No terms available at this time.";
                }
            } catch (e) {
                container.innerHTML = "Error loading terms. Please try again later.";
            }
        };

        window.closeTermsModal = () => {
            document.getElementById("termsModal").classList.remove("active");
        };

        // Password strength
        passwordInput.addEventListener("input", () => {
            const password = passwordInput.value;
            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.length >= 10) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            strengthBar.className = "password-strength-bar";
            if (strength <= 2) strengthBar.classList.add("weak");
            else if (strength <= 4) strengthBar.classList.add("medium");
            else strengthBar.classList.add("strong");
        });

        registerForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const name = document.getElementById("name").value;
            const confirmPassword = document.getElementById("confirmPassword").value;
            const agreeTerms = document.getElementById("agreeTerms").checked;

            if (!agreeTerms) { alert("Please agree to the Terms of Service."); return; }
            if (password !== confirmPassword) { alert("Passwords do not match!"); return; }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const profilePayload = {
                    role: "student",
                    name: name,
                    email: email,
                    institutionId: instSelect.value,
                    departmentId: deptSelect.value,
                    batchId: batchSelect.value
                };
                sessionStorage.setItem("pendingProfile", JSON.stringify(profilePayload));
                alert("Account created successfully! Please complete your profile.");
                window.location.href = "details.html";
            } catch (error) {
                alert(error.message);
            }
        });

        // Start fetching institutions
        fetchInstitutions();
    </script>
    <script src="js/theme.js" type="module"></script>
</body>

</html>