//super-admin-questions.html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Bank - Super Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filters select,
        .filters input {
            min-width: 150px;
        }

        .questions-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .questions-table th,
        .questions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .questions-table th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--text-primary);
        }

        .questions-table tr:hover {
            background: #f8fafc;
        }

        .question-text {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .option-input {
            margin-bottom: 10px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <header class="appbar">
        <h2>AptioGen - Question Bank</h2>
        <div class="right-icons">
            <i class="fa-solid fa-moon theme-toggle" title="Toggle Theme"></i>
            <a href="super-admin-dashboard.html"><i class="fa-solid fa-arrow-left" title="Back to Dashboard"></i></a>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <div>
                <h1>Question Bank Management</h1>
                <p>Add, edit, and manage platform questions</p>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-secondary" onclick="openUploadModal()">
                    <i class="fa-solid fa-file-upload"></i> Bulk Upload (PDF/DOCX)
                </button>
                <button class="btn btn-primary" onclick="openAddModal()">
                    <i class="fa-solid fa-plus"></i> Add Question
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="card">
            <div class="filters">
                <select id="categoryFilter" onchange="loadQuestions()">
                    <option value="">All Categories</option>
                    <option value="aptitude">Aptitude</option>
                    <option value="reasoning">Reasoning</option>
                    <option value="coding">Coding</option>
                    <option value="technical">Technical</option>
                </select>
                <select id="levelFilter" onchange="loadQuestions()">
                    <option value="">All Levels</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <input type="text" id="searchInput" placeholder="Search questions..." onkeyup="handleSearch()">
            </div>
        </div>

        <!-- Questions Table -->
        <div class="card mt-3">
            <div id="loading" class="loading">Loading questions...</div>
            <table class="questions-table" id="questionsTable" style="display:none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Question</th>
                        <th>Category</th>
                        <th>Level</th>
                        <th>Topic</th>
                        <th>Usage</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="questionsBody">
                </tbody>
            </table>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- Add/Edit Question Modal -->
    <div class="modal" id="questionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Question</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <form id="questionForm">
                <input type="hidden" id="questionId">

                <div class="form-group">
                    <label for="category">Category *</label>
                    <select id="category" required>
                        <option value="">Select Category</option>
                        <option value="aptitude">Aptitude</option>
                        <option value="reasoning">Reasoning</option>
                        <option value="coding">Coding</option>
                        <option value="technical">Technical</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="topic">Topic *</label>
                    <input type="text" id="topic" placeholder="e.g., Number Systems" required>
                </div>

                <div class="form-group">
                    <label for="level">Difficulty Level *</label>
                    <select id="level" required>
                        <option value="">Select Level</option>
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="question">Question *</label>
                    <textarea id="question" rows="3" placeholder="Enter the question" required></textarea>
                </div>

                <div class="form-group">
                    <label>Options *</label>
                    <input type="text" class="option-input" id="option1" placeholder="Option 1" required>
                    <input type="text" class="option-input" id="option2" placeholder="Option 2" required>
                    <input type="text" class="option-input" id="option3" placeholder="Option 3">
                    <input type="text" class="option-input" id="option4" placeholder="Option 4">
                </div>

                <div class="form-group">
                    <label for="correctAnswer">Correct Answer *</label>
                    <input type="text" id="correctAnswer" placeholder="Enter the correct answer exactly" required>
                </div>

                <div class="form-group">
                    <label for="explanation">Explanation (Optional)</label>
                    <textarea id="explanation" rows="2" placeholder="Explain the answer"></textarea>
                </div>

                <div class="form-group">
                    <label for="tags">Tags (comma-separated)</label>
                    <input type="text" id="tags" placeholder="e.g., math, basic, algebra">
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">Save Question</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div class="modal" id="uploadModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Bulk Upload Questions</h2>
                <button class="close-modal" onclick="closeUploadModal()">&times;</button>
            </div>
            <div class="p-4">
                <p class="mb-4">Upload a PDF or DOCX file. The system will extract questions, load them into the bank,
                    and generate practice sets automatically...</p>

                <div class="form-group mb-4">
                    <label for="uploadCategory" class="block mb-2 font-semibold">Target Category *</label>
                    <select id="uploadCategory" class="w-full p-2 border rounded" required>
                        <option value="">Select Category</option>
                        <option value="aptitude">Aptitude</option>
                        <option value="reasoning">Reasoning</option>
                        <option value="coding">Coding</option>
                        <option value="technical">Technical</option>
                    </select>
                </div>

                <div class="card bg-light p-4 mb-4 text-center" id="dropZone"
                    style="border: 2px dashed #cbd5e1; cursor: pointer;">
                    <i class="fa-solid fa-cloud-arrow-up fa-3x mb-3" style="color: #94a3b8;"></i>
                    <p>Click to select or drag and drop your file</p>
                    <p class="text-secondary small">Supported: .pdf, .docx (Max 10MB)</p>
                    <input type="file" id="fileInput" accept=".pdf,.docx" style="display: none;">
                </div>
                <div id="uploadStatus" class="mb-4" style="display: none;">
                    <p id="statusText" class="text-center">Processing file... Please wait.</p>
                </div>
                <div class="flex justify-end gap-2">
                    <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                    <button class="btn btn-primary" id="btnProcessUpload" disabled>Run Pipeline</button>
                </div>
            </div>
            <div id="reviewSection" style="display: none;" class="mt-4 pt-4 border-t">
                <h3 class="mb-3">Review Extracted Questions (<span id="extractedCount">0</span>)</h3>
                <div id="extractedList"
                    style="max-height: 400px; overflow-y: auto; padding: 10px; background: #f8fafc; border-radius: 8px;">
                </div>
                <button class="btn btn-success w-100 mt-4" id="btnConfirmBulk">Confirm & Import All</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initTheme } from './js/theme.js';
        import { auth } from './js/superAdminAPI.js';
        import API_CONFIG from './js/config.js';

        initTheme();

        const API_BASE = API_CONFIG.API_URL;
        let currentPage = 1;
        let searchTimeout;

        // Check authentication
        if (!auth.isLoggedIn()) {
            window.location.href = 'super-admin-login.html';
        }

        const authToken = auth.getToken();

        // Load questions
        window.loadQuestions = async (page = 1) => {
            const category = document.getElementById('categoryFilter').value;
            const level = document.getElementById('levelFilter').value;
            const search = document.getElementById('searchInput').value;

            const params = new URLSearchParams({
                page,
                limit: 10,
                ...(category && { category }),
                ...(level && { level }),
                ...(search && { search })
            });

            try {
                const response = await fetch(`${API_BASE}/super-admin/questions?${params}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (response.ok) {
                    displayQuestions(data.questions);
                    displayPagination(data.pagination);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('questionsTable').style.display = 'table';
                } else {
                    console.error('Failed to load questions:', data);
                }
            } catch (error) {
                console.error('Load questions error:', error);
            }
        };

        function displayQuestions(questions) {
            const tbody = document.getElementById('questionsBody');
            tbody.innerHTML = questions.map(q => `
                <tr>
                    <td>${q.questionID || 'N/A'}</td>
                    <td class="question-text" title="${q.question}">${q.question}</td>
                    <td><span class="badge badge-primary">${q.category}</span></td>
                    <td><span class="badge ${q.level === 'easy' ? 'badge-success' : q.level === 'medium' ? 'badge-warning' : 'badge-error'}">${q.level}</span></td>
                    <td>${q.topic}</td>
                    <td>${q.usageCount || 0}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editQuestion('${q._id}')" style="padding: 6px 12px; margin-right: 5px;">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteQuestion('${q._id}')" style="padding: 6px 12px;">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function displayPagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            const pages = [];

            for (let i = 1; i <= pagination.pages; i++) {
                pages.push(`
                    <button class="${i === pagination.page ? 'active' : ''}" onclick="loadQuestions(${i})">
                        ${i}
                    </button>
                `);
            }

            paginationDiv.innerHTML = `
                <button ${pagination.page === 1 ? 'disabled' : ''} onclick="loadQuestions(${pagination.page - 1})">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                ${pages.join('')}
                <button ${pagination.page === pagination.pages ? 'disabled' : ''} onclick="loadQuestions(${pagination.page + 1})">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
            `;
        }

        window.handleSearch = () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadQuestions(), 500);
        };

        window.openAddModal = () => {
            document.getElementById('modalTitle').textContent = 'Add Question';
            document.getElementById('questionForm').reset();
            document.getElementById('questionId').value = '';
            document.getElementById('questionModal').classList.add('active');
        };

        window.closeModal = () => {
            document.getElementById('questionModal').classList.remove('active');
        };

        window.editQuestion = async (id) => {
            // Fetch question details and populate form
            try {
                const response = await fetch(`${API_BASE}/super-admin/questions?search=${id}`);
                const data = await response.json();

                if (response.ok && data.questions.length > 0) {
                    const q = data.questions[0];
                    document.getElementById('modalTitle').textContent = 'Edit Question';
                    document.getElementById('questionId').value = q._id;
                    document.getElementById('category').value = q.category;
                    document.getElementById('topic').value = q.topic;
                    document.getElementById('level').value = q.level;
                    document.getElementById('question').value = q.question;
                    document.getElementById('option1').value = q.options[0] || '';
                    document.getElementById('option2').value = q.options[1] || '';
                    document.getElementById('option3').value = q.options[2] || '';
                    document.getElementById('option4').value = q.options[3] || '';
                    document.getElementById('correctAnswer').value = q.correctAnswer;
                    document.getElementById('explanation').value = q.explanation || '';
                    document.getElementById('tags').value = q.tags ? q.tags.join(', ') : '';
                    document.getElementById('questionModal').classList.add('active');
                }
            } catch (error) {
                console.error('Edit question error:', error);
            }
        };

        window.deleteQuestion = async (id) => {
            if (!confirm('Are you sure you want to delete this question?')) return;

            try {
                const response = await fetch(`${API_BASE}/super-admin/questions/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Question deleted successfully');
                    loadQuestions(currentPage);
                } else {
                    alert('Failed to delete question');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error deleting question');
            }
        };

        document.getElementById('questionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const options = [
                document.getElementById('option1').value,
                document.getElementById('option2').value,
                document.getElementById('option3').value,
                document.getElementById('option4').value
            ].filter(o => o.trim() !== '');

            const questionData = {
                category: document.getElementById('category').value,
                topic: document.getElementById('topic').value,
                level: document.getElementById('level').value,
                question: document.getElementById('question').value,
                options,
                correctAnswer: document.getElementById('correctAnswer').value,
                explanation: document.getElementById('explanation').value,
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t),
                createdBy: 'super-admin'
            };

            const questionId = document.getElementById('questionId').value;
            const url = questionId
                ? `${API_BASE}/super-admin/questions/${questionId}`
                : `${API_BASE}/super-admin/questions`;
            const method = questionId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(questionData)
                });

                if (response.ok) {
                    alert(questionId ? 'Question updated successfully' : 'Question added successfully');
                    closeModal();
                    loadQuestions(currentPage);
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to save question'));
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Error saving question');
            }
        });

        let extractedQuestions = [];

        window.openUploadModal = () => {
            document.getElementById('uploadModal').classList.add('active');
            document.getElementById('reviewSection').style.display = 'none';
            document.getElementById('uploadStatus').style.display = 'none';
            document.getElementById('btnProcessUpload').disabled = true;
            document.getElementById('fileInput').value = '';
        };

        window.closeUploadModal = () => {
            document.getElementById('uploadModal').classList.remove('active');
            extractedQuestions = [];
        };

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const btnProcessUpload = document.getElementById('btnProcessUpload');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
                dropZone.querySelector('p').textContent = fileInput.files[0].name;
                btnProcessUpload.disabled = false;
            }
        };

        btnProcessUpload.onclick = async () => {
            const file = fileInput.files[0];
            const category = document.getElementById('uploadCategory').value;

            if (!file) {
                alert('Please select a file');
                return;
            }
            if (!category) {
                alert('Please select a category');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('category', category);
            formData.append('creatorId', 'super-admin');

            document.getElementById('uploadStatus').style.display = 'block';
            const statusText = document.getElementById('statusText');
            statusText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing Question Pipeline...<br><span class="small text-secondary">1. Parsing -> 2. Loading -> 3. Generating Sets</span>';

            btnProcessUpload.disabled = true;

            try {
                const api = await import('./js/superAdminAPI.js');
                const result = await api.questionsAPI.runPipeline(formData);

                if (result.status === "success") {
                    document.getElementById('uploadStatus').style.display = 'none';
                    alert(`Pipeline completed successfully!\n\n• Questions Parsed: ${result.parsedCount}\n• Questions Loaded: ${result.loadedCount}\n• Practice Sets Generated: ${result.setsGenerated}`);

                    closeUploadModal();
                    loadQuestions();
                }
            } catch (error) {
                console.error('Pipeline error:', error);
                alert('Pipeline failed: ' + error.message);
                document.getElementById('uploadStatus').style.display = 'none';
                btnProcessUpload.disabled = false;
            }
        };


        function renderExtractedList() {
            const list = document.getElementById('extractedList');
            list.innerHTML = extractedQuestions.map((q, idx) => `
                <div class="card p-3 mb-2 small bg-light">
                    <strong>Q${idx + 1}:</strong> ${q.question}
                    <div class="text-secondary mt-1">Options: ${q.options.join(', ')}</div>
                    <div class="text-success mt-1">Answer: ${q.correctAnswer}</div>
                </div>
            `).join('');
        }

        document.getElementById('btnConfirmBulk').onclick = async () => {
            if (!confirm(`Are you sure you want to import ${extractedQuestions.length} questions?`)) return;

            try {
                const response = await fetch(`${API_BASE}/super-admin/questions/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ questions: extractedQuestions })
                });

                if (response.ok) {
                    alert('Questions imported successfully!');
                    closeUploadModal();
                    loadQuestions();
                }
            } catch (error) {
                alert('Import failed: ' + error.message);
            }
        };
    </script>
</body>

</html>