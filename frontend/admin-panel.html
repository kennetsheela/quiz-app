<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AptioGen - Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      padding-top: 80px;
      min-height: 100vh;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .sets-panel {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 25px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .set-item {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    
    .set-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .set-item.active-set {
      border: 2px solid var(--success);
      background: rgba(72, 187, 120, 0.1);
    }
    
    .set-item.selected {
      border: 2px solid var(--accent-primary);
      background: rgba(99, 102, 241, 0.1);
    }
    
    .set-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .toggle-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .toggle-btn.activate {
      background: var(--success);
      color: white;
    }
    
    .toggle-btn.deactivate {
      background: var(--error);
      color: white;
    }
    
    .stats-panel {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 25px;
    }
    
    .filter-bar {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .filter-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .filter-group label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 600;
    }
    
    .filter-group select {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-primary);
      cursor: pointer;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat-box {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-box h3 {
      font-size: 2rem;
      margin: 10px 0 5px 0;
      color: var(--accent-primary);
    }
    
    .stat-box p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .chart-box {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 10px;
    }
    
    .chart-box h4 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--text-primary);
    }
    
    .participants-table {
      width: 100%;
      margin-top: 20px;
    }
    
    .participants-table th {
      text-align: left;
      padding: 12px;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    
    .participants-table th:hover {
      background: var(--bg-tertiary);
    }
    
    .participants-table th i {
      margin-left: 5px;
      font-size: 0.8rem;
      opacity: 0.5;
    }
    
    .participants-table td {
      text-align: left;
      padding: 12px;
    }
    
    .password-modal, .export-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--overlay);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .password-modal.active, .export-modal.active {
      display: flex;
    }
    
    .export-modal-content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .export-option {
      padding: 15px;
      margin: 10px 0;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 15px;
      background: var(--bg-tertiary);
    }
    
    .export-option:hover {
      border-color: var(--accent-primary);
      background: rgba(99, 102, 241, 0.1);
      transform: translateY(-2px);
    }
    
    .export-option i {
      font-size: 2rem;
      color: var(--accent-primary);
    }
    
    .export-info h4 {
      margin: 0 0 5px 0;
      color: var(--text-primary);
    }
    
    .export-info p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .btn-export {
      background: var(--success);
      color: white;
    }
    
    .btn-reset {
      background: var(--warning);
      color: white;
    }
    
    .score-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .score-high { background: rgba(72, 187, 120, 0.2); color: var(--success); }
    .score-medium { background: rgba(251, 191, 36, 0.2); color: var(--warning); }
    .score-low { background: rgba(239, 68, 68, 0.2); color: var(--error); }
    
    .connection-status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-left: 10px;
    }
    
    .status-connected {
      background: rgba(72, 187, 120, 0.2);
      color: var(--success);
    }
    
    .status-error {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }
  </style>
</head>
<body>
  <div class="appbar">
    <h2>AptioGen - Admin Panel</h2>
    <div class="nav-links">
      <a href="explore.html">Explore</a>
      <a href="challenge.html">Challenge</a>
    </div>
    <div class="right-icons">
      <i class="fa-solid fa-moon theme-toggle"></i>
      <button class="btn btn-danger" onclick="deleteEventConfirm()">
        <i class="fas fa-trash"></i> Delete Event
      </button>
    </div>
  </div>

  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div>
        <h1 id="eventTitle">Loading Event...</h1>
        <span id="connectionStatus" class="connection-status status-connected">
          <i class="fas fa-circle"></i> Connected
        </span>
      </div>
      <button class="btn btn-secondary" onclick="window.location.href='challenge.html'">
        <i class="fas fa-arrow-left"></i> Back to Events
      </button>
    </div>

    <div class="dashboard-grid">
      <!-- Sets Control Panel -->
      <div class="sets-panel">
        <h2>Quiz Sets Control</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
          Click to analyze • Toggle to activate/deactivate
        </p>
        <div id="setsContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading sets...</p>
          </div>
        </div>
      </div>

      <!-- Statistics Panel -->
      <div class="stats-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 id="statsTitle">Overall Statistics</h2>
          <div class="action-buttons">
            <button class="btn btn-reset" onclick="resetFilters()">
              <i class="fas fa-redo"></i> Reset Filters
            </button>
            <button class="btn btn-export" onclick="exportData()">
              <i class="fas fa-download"></i> Export Report
            </button>
          </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
          <h4 style="margin-top: 0;"><i class="fas fa-filter"></i> Filters & Sorting</h4>
          <div class="filter-controls">
            <div class="filter-group">
              <label>Sort By</label>
              <select id="sortBy" onchange="applyFilters()">
                <option value="score-desc">Score (High to Low)</option>
                <option value="score-asc">Score (Low to High)</option>
                <option value="roll-asc">Roll Number (A-Z)</option>
                <option value="roll-desc">Roll Number (Z-A)</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Department</label>
              <select id="filterDepartment" onchange="applyFilters()">
                <option value="all">All Departments</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Score Range</label>
              <select id="filterScore" onchange="applyFilters()">
                <option value="all">All Scores</option>
                <option value="above80">Above 80%</option>
                <option value="50to80">50% - 80%</option>
                <option value="below50">Below 50%</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-box">
            <i class="fas fa-users" style="font-size: 2rem; color: var(--accent-primary);"></i>
            <h3 id="totalParticipants">0</h3>
            <p>Total Participants</p>
          </div>
          
          <div class="stat-box">
            <i class="fas fa-check" style="font-size: 2rem; color: var(--success);"></i>
            <h3 id="totalSubmissions">0</h3>
            <p>Submissions</p>
          </div>
          
          <div class="stat-box">
            <i class="fas fa-trophy" style="font-size: 2rem; color: #FFD700;"></i>
            <h3 id="above80">0</h3>
            <p>Scored >80%</p>
          </div>
          
          <div class="stat-box">
            <i class="fas fa-medal" style="font-size: 2rem; color: #C0C0C0;"></i>
            <h3 id="above50">0</h3>
            <p>Scored 50-80%</p>
          </div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
          <div class="chart-box">
            <h4>Score Distribution</h4>
            <canvas id="scoreChart"></canvas>
          </div>
          <div class="chart-box">
            <h4>Department Performance</h4>
            <canvas id="departmentChart"></canvas>
          </div>
        </div>

        <!-- Participants Table -->
        <h3>Participants (<span id="participantCount">0</span>)</h3>
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="participants-table">
            <thead>
              <tr>
                <th onclick="sortTable('rollNo')">
                  Roll No <i class="fas fa-sort"></i>
                </th>
                <th onclick="sortTable('department')">
                  Department <i class="fas fa-sort"></i>
                </th>
                <th onclick="sortTable('score')">
                  Score <i class="fas fa-sort"></i>
                </th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="participantsBody">
              <tr>
                <td colspan="4" class="text-center">Loading participants...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Password Modal -->
  <div class="password-modal" id="passwordModal">
    <div class="modal-content">
      <h3>Admin Authentication</h3>
      <p style="margin: 20px 0;">Enter admin password to continue</p>
      <input type="password" id="adminPassword" placeholder="Admin Password" style="margin-bottom: 20px;">
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmAction()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Export Options Modal -->
  <div class="export-modal" id="exportModal">
    <div class="export-modal-content">
      <h3>Export Report</h3>
      <p style="color: var(--text-secondary); margin-bottom: 20px;">Choose export format</p>
      
      <div class="export-option" onclick="exportAsCSV()">
        <i class="fas fa-file-csv"></i>
        <div class="export-info">
          <h4>CSV (Simple)</h4>
          <p>Basic spreadsheet format, opens in Excel</p>
        </div>
      </div>
      
      <div class="export-option" onclick="exportAsExcel()">
        <i class="fas fa-file-excel"></i>
        <div class="export-info">
          <h4>Excel (Detailed)</h4>
          <p>Formatted report with charts and summary</p>
        </div>
      </div>
      
      <div class="export-option" onclick="exportAsPDF()">
        <i class="fas fa-file-pdf"></i>
        <div class="export-info">
          <h4>PDF Report</h4>
          <p>Professional printable report</p>
        </div>
      </div>
      
      <button class="btn btn-secondary" onclick="closeExportModal()" style="margin-top: 20px; width: 100%;">
        Cancel
      </button>
    </div>
  </div>

  <script type="module">
    import { requireAuth } from "./js/auth.js";
    import { eventAPI } from "./js/api.js";

    requireAuth();

    const params = new URLSearchParams(window.location.search);
    const eventId = params.get('eventId');
    
    let currentEvent = null;
    let pendingAction = null;
    let selectedSetId = null;
    let allParticipants = [];
    let filteredParticipants = [];
    let scoreChart = null;
    let departmentChart = null;
    let refreshInterval = null;
    let connectionError = false;

    // Make these functions globally accessible
    window.currentEvent = null;
    window.selectedSetId = null;
    window.filteredParticipants = [];

    // Update connection status indicator
    function updateConnectionStatus(isConnected) {
      const statusEl = document.getElementById('connectionStatus');
      if (isConnected) {
        statusEl.className = 'connection-status status-connected';
        statusEl.innerHTML = '<i class="fas fa-circle"></i> Connected';
        connectionError = false;
      } else {
        statusEl.className = 'connection-status status-error';
        statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Connection Error';
        connectionError = true;
      }
    }

    async function loadEvent() {
      try {
        const { event } = await eventAPI.getEvent(eventId);
        currentEvent = event;
        window.currentEvent = event;
        
        document.getElementById('eventTitle').textContent = event.eventName;
        renderSets(event.sets);
        await loadStats();
        await loadParticipants();
        
        updateConnectionStatus(true);
        
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(async () => {
          try {
            await loadStats();
            await loadParticipants();
            updateConnectionStatus(true);
          } catch (error) {
            console.error("Auto-refresh error:", error);
            updateConnectionStatus(false);
          }
        }, 10000);
      } catch (error) {
        console.error("Error loading event:", error);
        updateConnectionStatus(false);
        
        if (error.message.includes('Failed to fetch')) {
          alert("Connection error: Unable to reach the server. Please check:\n1. Backend server is running\n2. CORS is properly configured\n3. Network connection is stable");
        } else {
          alert("Error loading event: " + error.message);
        }
      }
    }

    function renderSets(sets) {
      const setsHTML = sets.map(set => `
        <div class="set-item ${set.isActive ? 'active-set' : ''} ${selectedSetId === set._id ? 'selected' : ''}" 
             onclick="selectSet('${set._id}', event)">
          <div class="set-item-header">
            <div>
              <h4>${set.setName}</h4>
              <p style="margin: 5px 0; color: var(--text-secondary);">
                <i class="fas fa-clock"></i> ${set.timeLimit} minutes
              </p>
            </div>
            ${set.isActive ? '<span class="badge badge-available"><i class="fas fa-broadcast-tower"></i> LIVE</span>' : ''}
          </div>
          <button class="toggle-btn ${set.isActive ? 'deactivate' : 'activate'}" 
                  onclick="toggleSet('${set._id}', ${!set.isActive}, event)">
            ${set.isActive ? 'Deactivate' : 'Activate'}
          </button>
        </div>
      `).join('');
      
      document.getElementById('setsContainer').innerHTML = setsHTML;
    }

    window.selectSet = function(setId, event) {
      if (event.target.classList.contains('toggle-btn')) return;
      
      selectedSetId = selectedSetId === setId ? null : setId;
      window.selectedSetId = selectedSetId;
      renderSets(currentEvent.sets);
      applyFilters();
      
      const setName = currentEvent.sets.find(s => s._id === setId)?.setName || 'Overall';
      document.getElementById('statsTitle').textContent = 
        selectedSetId ? `${setName} Statistics` : 'Overall Statistics';
    };

    window.toggleSet = function(setId, enable, event) {
      event.stopPropagation();
      pendingAction = { setId, enable };
      document.getElementById('passwordModal').classList.add('active');
    };

    window.closePasswordModal = function() {
      document.getElementById('passwordModal').classList.remove('active');
      document.getElementById('adminPassword').value = '';
      pendingAction = null;
    };

    window.confirmAction = async function() {
      const password = document.getElementById('adminPassword').value;
      
      if (!password) {
        alert('Please enter admin password');
        return;
      }

      try {
        if (pendingAction.delete) {
          await eventAPI.deleteEvent(eventId, password);
          alert('Event deleted successfully!');
          window.location.href = 'challenge.html';
        } else {
          await eventAPI.toggleSet({
            eventId,
            setId: pendingAction.setId,
            adminPassword: password,
            enable: pendingAction.enable
          });
          alert(pendingAction.enable ? 'Set activated!' : 'Set deactivated!');
          closePasswordModal();
          loadEvent();
        }
      } catch (error) {
        console.error('Action error:', error);
        if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
          alert('Network error. Please check your connection and try again.');
        } else if (error.message.includes('password')) {
          alert('Incorrect admin password.');
        } else {
          alert('Error: ' + error.message);
        }
      }
    };

    async function loadStats() {
      try {
        const { stats } = await eventAPI.getStats(eventId);
        
        if (selectedSetId && allParticipants.length > 0) {
          calculateSetSpecificStats();
        } else {
          document.getElementById('totalParticipants').textContent = stats.totalParticipants;
          document.getElementById('totalSubmissions').textContent = stats.totalSubmissions;
          document.getElementById('above80').textContent = stats.above80;
          document.getElementById('above50').textContent = stats.above50;
        }
      } catch (error) {
        console.error("Error loading stats:", error);
        throw error;
      }
    }

    function calculateSetSpecificStats() {
      const setParticipants = allParticipants.filter(p => 
        p.setResults.some(r => r.setId === selectedSetId)
      );
      
      const submissions = setParticipants.filter(p => {
        const result = p.setResults.find(r => r.setId === selectedSetId);
        return result?.completedAt;
      });
      
      const above80Count = submissions.filter(p => {
        const result = p.setResults.find(r => r.setId === selectedSetId);
        return result.score > 80;
      }).length;
      
      const above50Count = submissions.filter(p => {
        const result = p.setResults.find(r => r.setId === selectedSetId);
        return result.score >= 50 && result.score <= 80;
      }).length;
      
      document.getElementById('totalParticipants').textContent = setParticipants.length;
      document.getElementById('totalSubmissions').textContent = submissions.length;
      document.getElementById('above80').textContent = above80Count;
      document.getElementById('above50').textContent = above50Count;
    }

    async function loadParticipants() {
      try {
        const { participants } = await eventAPI.getParticipants(eventId);
        allParticipants = participants;
        
        const departments = [...new Set(participants.map(p => p.department))].sort();
        const deptSelect = document.getElementById('filterDepartment');
        const currentDept = deptSelect.value;
        deptSelect.innerHTML = '<option value="all">All Departments</option>' +
          departments.map(d => `<option value="${d}">${d}</option>`).join('');
        deptSelect.value = currentDept;
        
        applyFilters();
      } catch (error) {
        console.error("Error loading participants:", error);
        throw error;
      }
    }

    window.applyFilters = function() {
      let filtered = [...allParticipants];
      
      if (selectedSetId) {
        filtered = filtered.filter(p => 
          p.setResults.some(r => r.setId === selectedSetId)
        );
      }
      
      const deptFilter = document.getElementById('filterDepartment').value;
      if (deptFilter !== 'all') {
        filtered = filtered.filter(p => p.department === deptFilter);
      }
      
      const scoreFilter = document.getElementById('filterScore').value;
      filtered = filtered.filter(p => {
        const result = selectedSetId 
          ? p.setResults.find(r => r.setId === selectedSetId)
          : p.setResults[0];
        
        if (!result?.score && result?.score !== 0) return scoreFilter === 'all';
        
        const score = result.score;
        if (scoreFilter === 'above80') return score > 80;
        if (scoreFilter === '50to80') return score >= 50 && score <= 80;
        if (scoreFilter === 'below50') return score < 50;
        return true;
      });
      
      const sortBy = document.getElementById('sortBy').value;
      filtered.sort((a, b) => {
        const aResult = selectedSetId 
          ? a.setResults.find(r => r.setId === selectedSetId)
          : a.setResults[0];
        const bResult = selectedSetId 
          ? b.setResults.find(r => r.setId === selectedSetId)
          : b.setResults[0];
        
        if (sortBy === 'score-desc') return (bResult?.score || 0) - (aResult?.score || 0);
        if (sortBy === 'score-asc') return (aResult?.score || 0) - (bResult?.score || 0);
        if (sortBy === 'roll-asc') return a.rollNo.localeCompare(b.rollNo);
        if (sortBy === 'roll-desc') return b.rollNo.localeCompare(a.rollNo);
        return 0;
      });
      
      filteredParticipants = filtered;
      window.filteredParticipants = filtered;
      renderParticipants();
      updateCharts();
      
      if (selectedSetId) {
        calculateSetSpecificStats();
      }
    };

    function renderParticipants() {
      document.getElementById('participantCount').textContent = filteredParticipants.length;
      
      if (filteredParticipants.length === 0) {
        document.getElementById('participantsBody').innerHTML = 
          '<tr><td colspan="4" class="text-center">No participants match the filters</td></tr>';
        return;
      }

      const participantsHTML = filteredParticipants.map(p => {
        const result = selectedSetId 
          ? p.setResults.find(r => r.setId === selectedSetId)
          : p.setResults[0];
        
        const score = result?.score ?? '-';
        const status = result?.completedAt ? '✅ Completed' : '⏳ In Progress';
        
        let scoreClass = '';
        if (typeof score === 'number') {
          if (score > 80) scoreClass = 'score-high';
          else if (score >= 50) scoreClass = 'score-medium';
          else scoreClass = 'score-low';
        }
        
        return `
          <tr>
            <td>${p.rollNo}</td>
            <td>${p.department}</td>
            <td><span class="score-badge ${scoreClass}">${score}</span></td>
            <td>${status}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('participantsBody').innerHTML = participantsHTML;
    }

    window.sortTable = function(field) {
      const sortBy = document.getElementById('sortBy');
      
      if (field === 'score') {
        sortBy.value = sortBy.value === 'score-desc' ? 'score-asc' : 'score-desc';
      } else if (field === 'rollNo') {
        sortBy.value = sortBy.value === 'roll-asc' ? 'roll-desc' : 'roll-asc';
      }
      
      applyFilters();
    };

    function updateCharts() {
      const completed = filteredParticipants.filter(p => {
        const result = selectedSetId 
          ? p.setResults.find(r => r.setId === selectedSetId)
          : p.setResults[0];
        return result?.completedAt;
      });
      
      const above80 = completed.filter(p => {
        const result = selectedSetId 
          ? p.setResults.find(r => r.setId === selectedSetId)
          : p.setResults[0];
        return result.score > 80;
      }).length;
      
      const between50and80 = completed.filter(p => {
        const result = selectedSetId 
          ? p.setResults.find(r => r.setId === selectedSetId)
          : p.setResults[0];
        return result.score >= 50 && result.score <= 80;
      }).length;
      
      const below50 = completed.filter(p => {
        const result = selectedSetId 
          ? p.setResults.find(r => r.setId === selectedSetId)
          : p.setResults[0];
        return result.score < 50;
      }).length;

      if (scoreChart) scoreChart.destroy();
      scoreChart = new Chart(document.getElementById('scoreChart'), {
        type: 'doughnut',
        data: {
          labels: ['Above 80%', '50-80%', 'Below 50%'],
          datasets: [{
            data: [above80, between50and80, below50],
            backgroundColor: ['#48bb78', '#fbbf24', '#ef4444']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      const deptStats = {};
      filteredParticipants.forEach(p => {
        const result = selectedSetId 
          ? p.setResults.find(r => r.setId === selectedSetId)
          : p.setResults[0];
        
        if (result?.score !== undefined && result?.score !== null) {
          if (!deptStats[p.department]) {
            deptStats[p.department] = { total: 0, count: 0 };
          }
          deptStats[p.department].total += result.score;
          deptStats[p.department].count += 1;
        }
      });

      const deptLabels = Object.keys(deptStats);
      const deptAvgs = deptLabels.map(d => 
        deptStats[d].count > 0 ? (deptStats[d].total / deptStats[d].count).toFixed(1) : 0
      );

      if (departmentChart) departmentChart.destroy();
      departmentChart = new Chart(document.getElementById('departmentChart'), {
        type: 'bar',
        data: {
          labels: deptLabels,
          datasets: [{
            label: 'Average Score',
            data: deptAvgs,
            backgroundColor: '#6366f1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: { beginAtZero: true, max: 100 }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    window.resetFilters = function() {
      selectedSetId = null;
      window.selectedSetId = null;
      document.getElementById('sortBy').value = 'score-desc';
      document.getElementById('filterDepartment').value = 'all';
      document.getElementById('filterScore').value = 'all';
      document.getElementById('statsTitle').textContent = 'Overall Statistics';
      renderSets(currentEvent.sets);
      applyFilters();
    };

    // Export Functions
    window.exportData = function() {
      document.getElementById('exportModal').classList.add('active');
    };

    window.closeExportModal = function() {
      document.getElementById('exportModal').classList.remove('active');
    };

    window.exportAsCSV = function() {
      const setName = window.selectedSetId 
        ? window.currentEvent.sets.find(s => s._id === window.selectedSetId)?.setName 
        : 'Overall';
      
      let csv = 'Roll No,Name,Department,Score,Status,Time Taken (min),Correct Answers,Wrong Answers,Skipped\n';
      
      window.filteredParticipants.forEach(p => {
        const result = window.selectedSetId 
          ? p.setResults.find(r => r.setId === window.selectedSetId)
          : p.setResults[0];
        
        const score = result?.score ?? 'N/A';
        const status = result?.completedAt ? 'Completed' : 'In Progress';
        const timeTaken = result?.timeTaken ? Math.round(result.timeTaken / 60) : 'N/A';
        const correct = result?.correctAnswers ?? 'N/A';
        const wrong = result?.wrongAnswers ?? 'N/A';
        const skipped = result?.skipped ?? 'N/A';
        
        csv += `${p.rollNo},${p.name || 'N/A'},${p.department},${score},${status},${timeTaken},${correct},${wrong},${skipped}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${window.currentEvent.eventName}-${setName}-Report.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      closeExportModal();
    };

    window.exportAsExcel = function() {
      const setName = window.selectedSetId 
        ? window.currentEvent.sets.find(s => s._id === window.selectedSetId)?.setName 
        : 'Overall';
      
      const wb = XLSX.utils.book_new();
      
      // Summary Sheet
      const summaryData = [
        ['Event Report'],
        [''],
        ['Event Name:', window.currentEvent.eventName],
        ['Set:', setName],
        ['Generated:', new Date().toLocaleString()],
        [''],
        ['Statistics'],
        ['Total Participants:', window.filteredParticipants.length],
        ['Completed:', window.filteredParticipants.filter(p => {
          const result = window.selectedSetId 
            ? p.setResults.find(r => r.setId === window.selectedSetId)
            : p.setResults[0];
          return result?.completedAt;
        }).length],
        ['Average Score:', calculateAverageScore().toFixed(2) + '%'],
        ['Highest Score:', calculateHighestScore() + '%'],
        ['Lowest Score:', calculateLowestScore() + '%'],
      ];
      
      const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');
      
      // Detailed Results Sheet
      const detailedData = [
        ['Roll No', 'Name', 'Department', 'Score (%)', 'Status', 'Time Taken (min)', 'Correct', 'Wrong', 'Skipped']
      ];
      
      window.filteredParticipants.forEach(p => {
        const result = window.selectedSetId 
          ? p.setResults.find(r => r.setId === window.selectedSetId)
          : p.setResults[0];
        
        detailedData.push([
          p.rollNo,
          p.name || 'N/A',
          p.department,
          result?.score ?? 'N/A',
          result?.completedAt ? 'Completed' : 'In Progress',
          result?.timeTaken ? Math.round(result.timeTaken / 60) : 'N/A',
          result?.correctAnswers ?? 'N/A',
          result?.wrongAnswers ?? 'N/A',
          result?.skipped ?? 'N/A'
        ]);
      });
      
      const detailedSheet = XLSX.utils.aoa_to_sheet(detailedData);
      detailedSheet['!cols'] = [
        { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 12 }, 
        { wch: 12 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 10 }
      ];
      
      XLSX.utils.book_append_sheet(wb, detailedSheet, 'Detailed Results');
      
      // Department Analysis Sheet
      const deptAnalysis = generateDepartmentAnalysis();
      const deptSheet = XLSX.utils.aoa_to_sheet(deptAnalysis);
      XLSX.utils.book_append_sheet(wb, deptSheet, 'Department Analysis');
      
      XLSX.writeFile(wb, `${window.currentEvent.eventName}-${setName}-Report.xlsx`);
      closeExportModal();
    };

    window.exportAsPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const setName = window.selectedSetId 
        ? window.currentEvent.sets.find(s => s._id === window.selectedSetId)?.setName 
        : 'Overall';
      
      doc.setFontSize(20);
      doc.setTextColor(99, 102, 241);
      doc.text(window.currentEvent.eventName, 14, 20);
      
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Set: ${setName}`, 14, 28);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 35);
      
      doc.setFillColor(240, 241, 255);
      doc.roundedRect(14, 42, 182, 35, 3, 3, 'F');
      
      doc.setFontSize(10);
      doc.text('Summary Statistics', 18, 50);
      doc.text(`Total Participants: ${window.filteredParticipants.length}`, 18, 58);
      doc.text(`Average Score: ${calculateAverageScore().toFixed(2)}%`, 18, 65);
      doc.text(`Highest Score: ${calculateHighestScore()}%`, 18, 72);
      
      const tableData = window.filteredParticipants.map(p => {
        const result = window.selectedSetId 
          ? p.setResults.find(r => r.setId === window.selectedSetId)
          : p.setResults[0];
        
        return [
          p.rollNo,
          p.name || 'N/A',
          p.department,
          result?.score ?? 'N/A',
          result?.completedAt ? '✓' : '⏳'
        ];
      });
      
      doc.autoTable({
        startY: 85,
        head: [['Roll No', 'Name', 'Department', 'Score (%)', 'Status']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [99, 102, 241] },
        styles: { fontSize: 9 }
      });
      
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(
          `Page ${i} of ${pageCount}`,
          doc.internal.pageSize.getWidth() / 2,
          doc.internal.pageSize.getHeight() - 10,
          { align: 'center' }
        );
      }
      
      doc.save(`${window.currentEvent.eventName}-${setName}-Report.pdf`);
      closeExportModal();
    };

    function calculateAverageScore() {
      const completed = window.filteredParticipants.filter(p => {
        const result = window.selectedSetId 
          ? p.setResults.find(r => r.setId === window.selectedSetId)
          : p.setResults[0];
        return result?.completedAt && result?.score !== undefined;
      });
      
      if (completed.length === 0) return 0;
      
      const total = completed.reduce((sum, p) => {
        const result = window.selectedSetId 
          ? p.setResults.find(r => r.setId === window.selectedSetId)
          : p.setResults[0];
        return sum + (result.score || 0);
      }, 0);
      
      return total / completed.length;
    }

    function calculateHighestScore() {
      const scores = window.filteredParticipants.map(p => {
        const result = window.selectedSetId 
          ? p.setResults.find(r => r.setId === window.selectedSetId)
          : p.setResults[0];
        return result?.score || 0;
      });
      
      return Math.max(...scores, 0);
    }

    function calculateLowestScore() {
      const completed = window.filteredParticipants.filter(p => {
        const result = window.selectedSetId 
          ? p.setResults.find(r => r.setId === window.selectedSetId)
          : p.setResults[0];
        return result?.completedAt && result?.score !== undefined;
      });
      
      if (completed.length === 0) return 0;
      
      const scores = completed.map(p => {
        const result = window.selectedSetId 
          ? p.setResults.find(r => r.setId === window.selectedSetId)
          : p.setResults[0];
        return result.score;
      });
      
      return Math.min(...scores);
    }

    function generateDepartmentAnalysis() {
      const deptStats = {};
      
      window.filteredParticipants.forEach(p => {
        const result = window.selectedSetId 
          ? p.setResults.find(r => r.setId === window.selectedSetId)
          : p.setResults[0];
        
        if (!deptStats[p.department]) {
          deptStats[p.department] = {
            total: 0,
            count: 0,
            completed: 0,
            scores: []
          };
        }
        
        deptStats[p.department].count++;
        
        if (result?.completedAt && result?.score !== undefined) {
          deptStats[p.department].total += result.score;
          deptStats[p.department].completed++;
          deptStats[p.department].scores.push(result.score);
        }
      });
      
      const analysis = [
        ['Department', 'Total Students', 'Completed', 'Average Score', 'Highest Score']
      ];
      
      Object.keys(deptStats).sort().forEach(dept => {
        const stats = deptStats[dept];
        const avg = stats.completed > 0 ? (stats.total / stats.completed).toFixed(2) : 'N/A';
        const highest = stats.scores.length > 0 ? Math.max(...stats.scores) : 'N/A';
        
        analysis.push([
          dept,
          stats.count,
          stats.completed,
          avg,
          highest
        ]);
      });
      
      return analysis;
    }

    window.deleteEventConfirm = function() {
      if (confirm('Are you sure you want to delete this event? This cannot be undone.')) {
        document.getElementById('passwordModal').classList.add('active');
        pendingAction = { delete: true };
      }
    };

    window.addEventListener('beforeunload', () => {
      if (refreshInterval) clearInterval(refreshInterval);
    });

    loadEvent();
  </script>
  <script src="js/theme.js" type="module"></script>
</body>
</html>