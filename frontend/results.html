results.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AptioGen - Quiz Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/components.css">
  <style>
    body {
      padding: 40px 20px;
      min-height: 100vh;
    }
    
    .results-container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .score-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 50px;
      text-align: center;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }
    
    .score-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    }
    
    .score-display {
      font-size: 5rem;
      font-weight: bold;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 20px 0;
    }
    
    .percentage {
      font-size: 2rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }
    
    .performance-badge {
      display: inline-block;
      padding: 10px 30px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 1.1rem;
      margin: 20px 0;
    }
    
    .badge-excellent {
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
    }
    
    .badge-good {
      background: linear-gradient(135deg, #4299e1, #3182ce);
      color: white;
    }
    
    .badge-average {
      background: linear-gradient(135deg, #ed8936, #dd6b20);
      color: white;
    }
    
    .badge-poor {
      background: linear-gradient(135deg, #f56565, #e53e3e);
      color: white;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .stat-box {
      background: var(--bg-tertiary);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-box i {
      font-size: 2.5rem;
      color: var(--accent-primary);
      margin-bottom: 10px;
    }
    
    .stat-box h3 {
      font-size: 2rem;
      margin: 10px 0 5px 0;
    }
    
    .stat-box p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .questions-review {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
    }
    
    .question-item {
      background: var(--bg-tertiary);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 4px solid transparent;
    }
    
    .question-item.correct {
      border-left-color: var(--success);
    }
    
    .question-item.incorrect {
      border-left-color: var(--error);
    }
    
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .question-number {
      font-weight: 600;
      color: var(--text-primary);
    }

    .question-meta {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .time-spent-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--card-bg);
      border: 2px solid var(--border-color);
    }

    .time-spent-badge i {
      font-size: 0.9rem;
    }

    .time-spent-badge.fast {
      background: rgba(72, 187, 120, 0.1);
      border-color: var(--success);
      color: var(--success);
    }

    .time-spent-badge.normal {
      background: rgba(66, 153, 225, 0.1);
      border-color: #4299e1;
      color: #4299e1;
    }

    .time-spent-badge.slow {
      background: rgba(237, 137, 54, 0.1);
      border-color: #ed8936;
      color: #ed8936;
    }
    
    .result-icon {
      font-size: 1.5rem;
    }
    
    .result-icon.correct {
      color: var(--success);
    }
    
    .result-icon.incorrect {
      color: var(--error);
    }
    
    .question-text {
      font-size: 1.1rem;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .answer-box {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .answer-label {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    
    .your-answer {
      color: var(--error);
    }
    
    .correct-answer {
      color: var(--success);
    }
    
    .explanation {
      background: var(--bg-tertiary);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 3px solid var(--accent-primary);
    }
    
    .explanation-label {
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .action-buttons button {
      min-width: 150px;
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--accent-primary);
      position: absolute;
      animation: confetti-fall 3s linear;
    }
    
    @keyframes confetti-fall {
      to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    .time-breakdown {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
    }

    .time-breakdown h3 {
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
    }

    .time-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .time-stat {
      text-align: center;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 8px;
    }

    .time-stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent-primary);
      margin-bottom: 5px;
    }

    .time-stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      .question-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .question-meta {
        width: 100%;
        justify-content: space-between;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="results-container">
    <div class="score-card">
      <h1>Quiz Completed! ðŸŽ‰</h1>
      <div class="score-display" id="scoreDisplay">-/-</div>
      <div class="percentage" id="percentageDisplay">-%</div>
      <div class="performance-badge" id="performanceBadge">Calculating...</div>
      
      <div class="stats-grid">
        <div class="stat-box">
          <i class="fas fa-check-circle"></i>
          <h3 id="correctCount">0</h3>
          <p>Correct Answers</p>
        </div>
        
        <div class="stat-box">
          <i class="fas fa-times-circle"></i>
          <h3 id="incorrectCount">0</h3>
          <p>Incorrect Answers</p>
        </div>
        
        <div class="stat-box">
          <i class="fas fa-clock"></i>
          <h3 id="timeSpent">0m 0s</h3>
          <p>Total Time</p>
        </div>
        
        <div class="stat-box">
          <i class="fas fa-chart-line"></i>
          <h3 id="accuracy">0%</h3>
          <p>Accuracy</p>
        </div>
      </div>

      <!-- Time Breakdown Section - Only shows if per-question time data is available -->
      <div class="time-breakdown" id="timeBreakdown" style="display: none;">
        <h3>
          <i class="fas fa-stopwatch"></i>
          Time Analysis
        </h3>
        <div class="time-stats">
          <div class="time-stat">
            <div class="time-stat-value" id="avgTimePerQuestion">0s</div>
            <div class="time-stat-label">Avg per Question</div>
          </div>
          <div class="time-stat">
            <div class="time-stat-value" id="fastestQuestion">0s</div>
            <div class="time-stat-label">Fastest Answer</div>
          </div>
          <div class="time-stat">
            <div class="time-stat-value" id="slowestQuestion">0s</div>
            <div class="time-stat-label">Slowest Answer</div>
          </div>
        </div>
      </div>
    </div>

    <div class="questions-review">
      <h2>Detailed Review</h2>
      <div id="questionsContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading results...</p>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-secondary" onclick="goBack()">
        <i class="fas fa-arrow-left"></i> Back to Topics
      </button>
      <button class="btn btn-primary" id="retryBtn">
        <i class="fas fa-redo"></i> Retry Quiz
      </button>
      <button class="btn btn-success" id="nextBtn" style="display: none;">
        <i class="fas fa-arrow-right"></i> Next Set
      </button>
    </div>
  </div>

  <script type="module">
    import { requireAuth } from "./js/auth.js";
    import { practiceAPI } from "./js/api.js";

    requireAuth();

    const params = new URLSearchParams(window.location.search);
    const category = params.get('category');
    const topic = params.get('topic');
    const level = params.get('level');
    const setNumber = parseInt(params.get('set'));

    let resultsData = null;

    function formatTime(seconds) {
      if (!seconds && seconds !== 0) return 'N/A';
      if (seconds < 60) return `${seconds}s`;
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}m ${secs}s`;
    }

    function getTimeSpeedClass(timeSpent, avgTime) {
      if (!timeSpent || !avgTime) return 'normal';
      if (timeSpent < avgTime * 0.7) return 'fast';
      if (timeSpent > avgTime * 1.5) return 'slow';
      return 'normal';
    }

    // âœ… NEW: Check if per-question time data is available
    function hasPerQuestionTimeData(results) {
      if (!results || results.length === 0) return false;
      
      // Check if at least one question has time data
      return results.some(r => {
        const time = r.timeSpent || r.timeTaken || r.duration;
        return time !== undefined && time !== null && time > 0;
      });
    }

    function calculateTimeStats(results) {
      const times = results
        .map(r => r.timeSpent || r.timeTaken || r.duration)
        .filter(t => t !== undefined && t !== null && t > 0);
      
      if (times.length === 0) return null;

      const total = times.reduce((sum, t) => sum + t, 0);
      const avg = Math.round(total / times.length);
      const fastest = Math.min(...times);
      const slowest = Math.max(...times);

      return { avg, fastest, slowest, total };
    }

    async function loadResults() {
      try {
        console.log("ðŸ“Š Loading results...");
        
        const storedResults = sessionStorage.getItem('quizResults');
        
if (storedResults) {
  console.log("âœ… Found stored results");
  resultsData = JSON.parse(storedResults);
  
  // â­ DETAILED DEBUG - Add these lines
  console.log("ðŸ” FULL resultsData object:", resultsData);
  console.log("ðŸ” Results array:", resultsData.results);
  console.log("ðŸ” Number of results:", resultsData.results?.length);
  
  if (resultsData.results && resultsData.results.length > 0) {
    console.log("ðŸ” First result structure:", resultsData.results[0]);
    console.log("ðŸ” First result keys:", Object.keys(resultsData.results[0]));
    console.log("ðŸ” First result timeSpent:", resultsData.results[0].timeSpent);
    console.log("ðŸ” First result has timeSpent?", 'timeSpent' in resultsData.results[0]);
    
    // Check all results
    const timingsPresent = resultsData.results.map((r, i) => ({
      question: i + 1,
      hasTimeSpent: 'timeSpent' in r,
      timeSpent: r.timeSpent
    }));
    console.log("ðŸ” All results timing data:", timingsPresent);
  }
  
  displayResults(resultsData);
  sessionStorage.removeItem('quizResults');
} else {
          console.log("âš ï¸ No stored results, trying to fetch from backend...");
          
          try {
            const progressData = await practiceAPI.getProgress();
            const thisProgress = progressData.progress.find(p => 
              p.category === category && 
              p.topic === topic && 
              p.level === level && 
              p.setNumber === setNumber &&
              p.completed
            );
            
            if (thisProgress) {
              console.log("âœ… Found progress data:", thisProgress);
              displayBasicResults(thisProgress.score, thisProgress.totalQuestions);
            } else {
              console.log("âŒ No matching progress found");
              displayError();
            }
          } catch (error) {
            console.error("âŒ Error fetching progress:", error);
            displayError();
          }
        }
      } catch (error) {
        console.error("âŒ Error loading results:", error);
        displayError();
      }
    }

    function displayResults(data) {
      console.log("ðŸŽ¨ Displaying full results:", data);
      
      const score = data.score || 0;
      const totalQuestions = data.totalQuestions || 0;
      const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
      
      // Update score display
      document.getElementById('scoreDisplay').textContent = `${score}/${totalQuestions}`;
      document.getElementById('percentageDisplay').textContent = `${percentage}%`;
      document.getElementById('correctCount').textContent = score;
      document.getElementById('incorrectCount').textContent = totalQuestions - score;
      document.getElementById('accuracy').textContent = percentage + '%';
      
      // Display time spent (total time only)
      const timeSpent = data.timeSpent;
      if (timeSpent !== undefined && timeSpent !== null) {
        const minutes = Math.floor(timeSpent / 60);
        const seconds = timeSpent % 60;
        document.getElementById('timeSpent').textContent = `${minutes}m ${seconds}s`;
      } else {
        document.getElementById('timeSpent').textContent = "N/A";
      }
      
      // Performance badge
      const badge = document.getElementById('performanceBadge');
      if (percentage >= 90) {
        badge.textContent = 'ðŸ† Excellent!';
        badge.className = 'performance-badge badge-excellent';
        createConfetti();
      } else if (percentage >= 70) {
        badge.textContent = 'ðŸ‘ Good Job!';
        badge.className = 'performance-badge badge-good';
      } else if (percentage >= 50) {
        badge.textContent = 'ðŸ“š Keep Practicing';
        badge.className = 'performance-badge badge-average';
      } else {
        badge.textContent = 'ðŸ’ª Try Again';
        badge.className = 'performance-badge badge-poor';
      }
      
      // âœ… NEW: Only calculate time statistics if per-question data exists
      let timeStats = null;
      const hasTimeData = hasPerQuestionTimeData(data.results);
      
      if (hasTimeData) {
        timeStats = calculateTimeStats(data.results);
        
        if (timeStats) {
          console.log("â±ï¸ Time statistics available:", timeStats);
          document.getElementById('timeBreakdown').style.display = 'block';
          document.getElementById('avgTimePerQuestion').textContent = `${timeStats.avg}s`;
          document.getElementById('fastestQuestion').textContent = `${timeStats.fastest}s`;
          document.getElementById('slowestQuestion').textContent = `${timeStats.slowest}s`;
        }
      } else {
        console.log("â„¹ï¸ Per-question time data not available - hiding time analysis");
      }
      
      // Display detailed results
      if (data.results && data.results.length > 0) {
        const questionsHTML = data.results.map((result, index) => {
          const normalizeAnswer = (ans) => ans ? ans.toString().trim().toLowerCase() : '';
          
          const selectedAnswer = result.selectedAnswer || result.userAnswer || result.answer || null;
          const correctAnswer = result.correctAnswer || result.correct || null;
          
          let isCorrect = result.isCorrect;
          if (isCorrect === undefined || isCorrect === null) {
            isCorrect = selectedAnswer && correctAnswer && 
                       normalizeAnswer(selectedAnswer) === normalizeAnswer(correctAnswer);
          }
          
          // âœ… NEW: Only get time if available
          const questionTime = result.timeSpent || result.timeTaken || result.duration || null;
          const showTimeForThisQuestion = hasTimeData && (questionTime !== null && questionTime !== undefined);
          
          const timeClass = timeStats && showTimeForThisQuestion 
            ? getTimeSpeedClass(questionTime, timeStats.avg) 
            : 'normal';
          
          return `
            <div class="question-item ${isCorrect ? 'correct' : 'incorrect'}">
              <div class="question-header">
                <span class="question-number">Question ${index + 1}</span>
                <div class="question-meta">
                  ${showTimeForThisQuestion ? `
                    <span class="time-spent-badge ${timeClass}">
                      <i class="fas fa-clock"></i>
                      ${formatTime(questionTime)}
                    </span>
                  ` : ''}
                  <i class="fas ${isCorrect ? 'fa-check-circle' : 'fa-times-circle'} result-icon ${isCorrect ? 'correct' : 'incorrect'}"></i>
                </div>
              </div>
              
              <div class="question-text">${result.question}</div>
              
              ${!isCorrect ? `
                <div class="answer-box">
                  <div class="answer-label your-answer">Your Answer:</div>
                  <div>${selectedAnswer || 'Not answered'}</div>
                </div>
              ` : ''}
              
              <div class="answer-box">
                <div class="answer-label correct-answer">Correct Answer:</div>
                <div>${correctAnswer}</div>
              </div>
              
              ${result.explanation ? `
                <div class="explanation">
                  <div class="explanation-label">
                    <i class="fas fa-lightbulb"></i>
                    Explanation
                  </div>
                  <div>${result.explanation}</div>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
        
        document.getElementById('questionsContainer').innerHTML = questionsHTML;
      } else {
        document.getElementById('questionsContainer').innerHTML = 
          '<p style="text-align: center; color: var(--text-secondary);">Detailed review will be available soon.</p>';
      }
      
      checkNextSet();
    }

    function displayBasicResults(score, total) {
      console.log("ðŸŽ¨ Displaying basic results:", score, "/", total);
      
      const percentage = Math.round((score / total) * 100);
      
      document.getElementById('scoreDisplay').textContent = `${score}/${total}`;
      document.getElementById('percentageDisplay').textContent = `${percentage}%`;
      document.getElementById('correctCount').textContent = score;
      document.getElementById('incorrectCount').textContent = total - score;
      document.getElementById('accuracy').textContent = percentage + '%';
      
      const badge = document.getElementById('performanceBadge');
      if (percentage >= 90) {
        badge.textContent = 'ðŸ† Excellent!';
        badge.className = 'performance-badge badge-excellent';
        createConfetti();
      } else if (percentage >= 70) {
        badge.textContent = 'ðŸ‘ Good Job!';
        badge.className = 'performance-badge badge-good';
      } else if (percentage >= 50) {
        badge.textContent = 'ðŸ“š Keep Practicing';
        badge.className = 'performance-badge badge-average';
      } else {
        badge.textContent = 'ðŸ’ª Try Again';
        badge.className = 'performance-badge badge-poor';
      }
      
      document.getElementById('questionsContainer').innerHTML = 
        '<p style="text-align: center; color: var(--text-secondary);">Detailed review is not available for this quiz.</p>';
      
      checkNextSet();
    }

    function displayError() {
      document.getElementById('questionsContainer').innerHTML = 
        '<p style="text-align: center; color: var(--error);">Could not load results. Please try again.</p>';
    }

    async function checkNextSet() {
      try {
        const { sets } = await practiceAPI.getSets(category, topic, level);
        const nextSet = sets.find(s => s.setNumber === setNumber + 1 && !s.locked);
        
        if (nextSet) {
          document.getElementById('nextBtn').style.display = 'block';
          document.getElementById('nextBtn').onclick = () => {
            window.location.href = `quiz.html?category=${category}&topic=${topic}&level=${level}&set=${setNumber + 1}`;
          };
        }
      } catch (error) {
        console.error("Error checking next set:", error);
      }
    }

    function createConfetti() {
      const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * window.innerWidth + 'px';
          confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 3 + 's';
          document.body.appendChild(confetti);
          
          setTimeout(() => confetti.remove(), 3000);
        }, i * 30);
      }
    }

    window.goBack = function() {
      window.location.href = `${category}.html`;
    };

    document.getElementById('retryBtn').onclick = function() {
      window.location.href = `quiz.html?category=${category}&topic=${topic}&level=${level}&set=${setNumber}`;
    };

    loadResults();
  </script>
  <script src="js/theme.js" type="module"></script>
</body>
</html>